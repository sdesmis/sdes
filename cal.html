<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行事曆</title>
    <link href="https://fonts.googleapis.com/css2?family=Iansui:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-text: #000;
            --weekend-red: #d90606;
            --focus-outline: #005a9c;
            --border-width: 0.125rem; 
            --border-style: solid var(--primary-text);
        }

        body {
            font-family: 'Iansui', sans-serif;
            background: #fff;
            color: var(--primary-text);
            /* AAA 規範修正：最大寬度不超過 80 個英文字符 (40 中文字) */
            max-width: 80ch; 
            margin: 2rem auto;
            padding: 0 1.25rem;
            line-height: 1.5;
            overflow-wrap: break-word;
        }

        /* 頁籤與按鈕 */
        .tabs { display: flex; gap: 0.625rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .tab-btn { 
            padding: 0.6em 1.2em; border: var(--border-width) var(--border-style); 
            background: #fff; cursor: pointer; font-weight: bold; font-family: inherit; font-size: 1.1rem;
        }
        .tab-btn[aria-selected="true"] { background: #000; color: #fff; }

        .controls { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .nav-btn { padding: 0.5em 1em; border: var(--border-width) var(--border-style); background: #eee; cursor: pointer; font-weight: bold; }

        /* 表格結構 - 相對高度與百分比寬度 */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { border: var(--border-width) var(--border-style); background: #f4f4f4; padding: 0.6rem 0.3rem; height: auto; }
        td { border: var(--border-width) var(--border-style); padding: 0.5rem; vertical-align: top; height: 8.5rem; }
        
        .weekend { color: var(--weekend-red); }

        /* 行程標籤樣式 */
        .event-item {
            background: #f0f0f0; border-left: 0.3rem solid #000;
            padding: 0.25rem 0.5rem; margin-top: 0.3rem; font-size: 0.9rem;
            cursor: pointer; display: block; text-align: left;
            text-decoration: none;
            color: inherit;
        }
        .event-item:hover, .event-item:focus { background: #e0e0e0; }
        .all-day-tag { background: #333; color: #fff; border-left: 0.3rem solid var(--weekend-red); }

        /* 彈出視窗 (Modal) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; border: 0.25rem solid #000; padding: 1.8rem;
            max-width: 40ch; /* 限制寬度以符合閱讀性 */
            width: 85%; position: relative;
        }
        .close-btn { position: absolute; top: 0.6rem; right: 0.6rem; padding: 0.4rem 0.8rem; border: 0.125rem solid #000; cursor: pointer; font-weight: bold; }

        /* 輔助與焦點控制 */
        *:focus { outline: 0.3rem solid var(--focus-outline); outline-offset: 0.125rem; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        
        .time-label { font-weight: bold; font-size: 0.8rem; display: block; margin-bottom: 0.1rem; }
    </style>
</head>
<body>

<header>
    <h1>行事曆</h1>
    <nav class="tabs" role="tablist">
        <button role="tab" class="tab-btn" id="tab-month" aria-selected="true" onclick="updateMode('month')">月檢視</button>
        <button role="tab" class="tab-btn" id="tab-week" aria-selected="false" onclick="updateMode('week')">週檢視</button>
        <button role="tab" class="tab-btn" id="tab-day" aria-selected="false" onclick="updateMode('day')">日檢視</button>
    </nav>
    <div class="controls">
        <h2 id="current-label" aria-live="polite">載入中...</h2>
        <button class="nav-btn" onclick="navView(-1)">前一個</button>
        <button class="nav-btn" onclick="navView(0)">今天</button>
        <button class="nav-btn" onclick="navView(1)">後一個</button>
    </div>
</header>

<main id="calendar-container">
    <table role="grid">
        <thead id="cal-head"></thead>
        <tbody id="cal-body"></tbody>
    </table>
</main>

<div id="modal" class="modal-overlay" onclick="if(event.target===this) closeModal()">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="m-title" tabindex="-1">
        <button class="close-btn" onclick="closeModal()">關閉</button>
        <h2 id="m-title">行程詳情</h2>
        <hr style="margin: 1rem 0; border: 0; border-top: 0.0625rem solid #000;">
        <div id="m-body"></div>
    </div>
</div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwMS8k7-IO3Ox9Le07fACJF2F0CiCEksoyAgW_8gIR9pPv2olZHKGTdsMsHs6h_-sw/exec'; 
    let currDate = new Date();
    let currMode = 'month';
    let eventsData = [];
    let lastActive;

    async function fetchData() {
        document.getElementById('current-label').innerText = "連線中...";
        try {
            const response = await fetch(`${GAS_URL}?year=${currDate.getFullYear()}&month=${currDate.getMonth()+1}`);
            eventsData = await response.json();
            render();
        } catch(e) { 
            document.getElementById('current-label').innerText = "讀取失敗"; 
        }
    }

    function updateMode(m) { currMode = m; render(); }

    function navView(n) {
        if (n === 0) currDate = new Date();
        else {
            if (currMode === 'month') currDate.setMonth(currDate.getMonth() + n);
            else if (currMode === 'week') currDate.setDate(currDate.getDate() + n * 7);
            else currDate.setDate(currDate.getDate() + n);
        }
        fetchData();
    }

    function render() {
        const head = document.getElementById('cal-head');
        const body = document.getElementById('cal-body');
        const label = document.getElementById('current-label');
        
        body.innerHTML = '';
        head.innerHTML = '';
        document.querySelectorAll('.tab-btn').forEach(b => b.setAttribute('aria-selected', b.id === `tab-${currMode}`));

        if (currMode === 'month') renderMonth(head, body, label);
        else if (currMode === 'week') renderWeek(head, body, label);
        else if (currMode === 'day') renderDay(head, body, label);
    }

    function renderMonth(h, b, l) {
        l.innerText = `${currDate.getFullYear()}年 ${currDate.getMonth()+1}月`;
        h.innerHTML = `<tr><th class="weekend">星期日</th><th>星期一</th><th>星期二</th><th>星期三</th><th>星期四</th><th>星期五</th><th class="weekend">星期六</th></tr>`;
        
        let f = new Date(currDate.getFullYear(), currDate.getMonth(), 1).getDay();
        let dMax = new Date(currDate.getFullYear(), currDate.getMonth() + 1, 0).getDate();
        let d = 1;

        for (let i = 0; i < 6; i++) {
            let tr = document.createElement('tr');
            for (let j = 0; j < 7; j++) {
                let td = document.createElement('td');
                if ((i === 0 && j < f) || d > dMax) tr.appendChild(td);
                else {
                    const ds = `${currDate.getFullYear()}-${String(currDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const evs = eventsData.filter(e => e.start.startsWith(ds));
                    td.tabIndex = 0;
                    if (j === 0 || j === 6) td.classList.add('weekend');
                    td.setAttribute('aria-label', `${d}日, ${evs.length}個行程`);
                    td.innerHTML = `<strong>${d}</strong>`;
                    evs.forEach(e => td.appendChild(createEv(e)));
                    td.onclick = () => openModal(null, ds, evs);
                    td.onkeydown = (e) => { if(e.key==='Enter') openModal(null, ds, evs); };
                    tr.appendChild(td);
                    d++;
                }
            }
            b.appendChild(tr);
            if (d > dMax) break;
        }
    }

    function renderWeek(h, b, l) {
        let s = new Date(currDate); s.setDate(currDate.getDate() - currDate.getDay());
        l.innerText = `${s.toLocaleDateString()} 起的一週`;
        h.innerHTML = `<tr><th style="width: 30%;">日期</th><th>行程詳情</th></tr>`;
        for (let i = 0; i < 7; i++) {
            let d = new Date(s); d.setDate(s.getDate() + i);
            let ds = d.toISOString().split('T')[0];
            let evs = eventsData.filter(e => e.start.startsWith(ds));
            let tr = document.createElement('tr');
            tr.innerHTML = `<td style="height: auto; ${i===0||i===6?'color:var(--weekend-red)':''}">
                <strong>星期${['日','一','二','三','四','五','六'][i]}</strong><br>${d.getMonth()+1}/${d.getDate()}
            </td><td id="w-${i}" style="height: auto;"></td>`;
            b.appendChild(tr);
            const c = document.getElementById(`w-${i}`);
            if (evs.length) evs.forEach(e => c.appendChild(createEv(e)));
            else c.innerText = '今日無行程';
        }
    }

    function renderDay(h, b, l) {
        l.innerText = `${currDate.toLocaleDateString()} (星期${['日','一','二','三','四','五','六'][currDate.getDay()]})`;
        h.innerHTML = `<tr><th style="width: 25%;">時間軸</th><th>內容</th></tr>`;
        const ds = currDate.toISOString().split('T')[0];
        const evs = eventsData.filter(e => e.start.startsWith(ds));
        for (let i = 0; i < 24; i++) {
            let tr = document.createElement('tr');
            let hStr = String(i).padStart(2, '0') + ':00';
            tr.innerHTML = `<td style="height: 3.5rem; text-align: center; background: #f9f9f9;">${hStr}</td><td id="d-${i}" style="height: 3.5rem;"></td>`;
            b.appendChild(tr);
            const c = document.getElementById(`d-${i}`);
            evs.filter(e => (e.isAllDay && i===0) || (new Date(e.start).getHours() === i)).forEach(e => c.appendChild(createEv(e)));
        }
    }

    function createEv(e) {
        let d = document.createElement('div');
        d.className = 'event-item' + (e.isAllDay ? ' all-day-tag' : '');
        d.innerHTML = `<span class="time-label">${e.timeDisplay}</span>${e.title}`;
        d.tabIndex = 0;
        d.onclick = (ex) => { ex.stopPropagation(); openModal(e); };
        d.onkeydown = (ex) => { if(ex.key==='Enter') { ex.stopPropagation(); openModal(e); } };
        return d;
    }

    function openModal(e, ds, evs) {
        lastActive = document.activeElement;
        const m = document.getElementById('modal');
        const b = document.getElementById('m-body');
        m.style.display = 'flex';
        if (e) {
            b.innerHTML = `<h3>${e.title}</h3><p><strong>時間：</strong>${e.timeDisplay}</p><p><strong>地點：</strong>${e.location||'未標註'}</p><p><strong>備註：</strong>${e.desc||'無描述'}</p>`;
        } else {
            b.innerHTML = `<h3>${ds} 行程總覽</h3>` + (evs.length ? '' : '<p>無安排行程</p>');
            if(evs.length) evs.forEach(x => b.appendChild(createEv(x)));
        }
        document.querySelector('.modal-content').focus();
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        if (lastActive) lastActive.focus();
    }

    window.onkeydown = (e) => { if(e.key === 'Escape') closeModal(); };
    fetchData();
</script>
</body>
</html>