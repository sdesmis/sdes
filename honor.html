<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>榮譽榜</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: transparent;
            --text-color: #333;
            --title-color: #333;
            --meta-color: #999;
            --link-color: #337ab7;
            --border-color: #eee;
            
            /* 彈窗專用顏色 */
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --badge-bg: #fff9c4;
            --badge-text: #8d6e63;
            
            /* 字體設定 */
            --main-font: "Iansui", "Microsoft JhengHei", "Heiti TC", sans-serif;

            /* 分類標籤顏色 */
            --cat-all-bg: #3498db;      
            --cat-intl-bg: #8bc34a;     
            --cat-nat-bg: #2ecc71;      
            --cat-city-bg: #f39c12;     
            --cat-dist-bg: #4fc3f7;     
            --cat-school-bg: #9b59b6;   
            --cat-grade-bg: #e91e63;    
            --cat-private-bg: #81c784;  
        }

        /* 全域 Box Sizing */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Body 歸零並隱藏捲軸 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            font-family: var(--main-font);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* 容器控制邊距 */
        .main-wrapper {
            padding: 10px;
            width: 100%;
            max-width: 100vw;
        }

        /* 無障礙專用隱藏類別 */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
        }

        /* --- 分類篩選區塊樣式 --- */
        .filter-section {
            display: flex; flex-wrap: wrap; gap: 8px;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #ccc;
        }
        .filter-btn {
            border: none; border-radius: 4px; color: #fff;
            padding: 6px 10px; font-size: 1rem; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px;
            transition: opacity 0.2s, transform 0.1s;
            font-family: inherit;
        }
        .filter-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .filter-btn:active { transform: translateY(0); }
        .filter-btn.inactive { opacity: 0.4; background-color: #999 !important; }

        .count-pill {
            background-color: rgba(0, 0, 0, 0.25);
            border-radius: 10px; padding: 0 8px; font-size: 0.9rem;
            min-width: 24px; text-align: center;
        }

        /* --- 列表樣式 --- */
        .honor-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .honor-item {
            display: flex;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            width: 100%;
        }

        /* 左側圖片區 (電腦版) */
        .honor-img-box {
            flex-shrink: 0;
            width: 240px; 
            height: 160px;
            position: relative; /* 為了讓內部絕對定位生效 */
        }

        /* 讓按鈕填滿容器 */
        .honor-img-box button.title-btn {
            width: 100% !important;
            height: 100% !important;
            display: block;
            padding: 0;
            border: none;
        }

        .honor-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 關鍵：裁切填滿，不變形 */
            border: 1px solid #ddd;
            padding: 3px;
            background: #fff;
            display: block; 
        }

        /* 右側內容區 */
        .honor-content-box {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        h2.honor-title {
            margin: 0 0 10px 0;
            line-height: 1.5;
        }

        .title-btn {
            background: none;
            border: none;
            padding: 0;
            font-size: 1.25rem;
            font-weight: normal;
            color: var(--title-color);
            text-align: left;
            cursor: pointer;
            font-family: inherit;
            line-height: 1.5;
            text-decoration: none;
            word-wrap: break-word;
        }
        .title-btn:hover {
            color: var(--link-color);
            text-decoration: underline;
        }

        .honor-desc {
            font-size: 1.05rem;
            color: #444;
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-break: break-word; 
            overflow-wrap: break-word;
        }

        .desc-truncated {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .show-more-btn {
            color: var(--link-color);
            cursor: pointer;
            font-size: 0.95rem;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 10px;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
            text-align: left;
        }
        .show-more-btn:hover { text-decoration: underline; }

        .honor-meta {
            margin-top: auto;
            text-align: right;
            font-size: 0.9rem;
            color: var(--meta-color);
            display: flex;
            flex-wrap: wrap; 
            justify-content: flex-end;
            gap: 10px;
        }
        .cat-tag {
            color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;
        }

        /* 分頁樣式 */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 5px; margin-top: 30px; margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #fff;
            color: var(--link-color);
            cursor: pointer;
            text-decoration: none;
            font-size: 1rem;
            border-radius: 4px;
            min-width: 35px;
            font-family: inherit;
        }
        .page-btn:hover { background-color: #eee; }
        .page-btn.active { background-color: var(--link-color); color: #fff; border-color: var(--link-color); }
        .page-btn:disabled { color: #ccc; cursor: not-allowed; }

        #loading { text-align: center; color: #666; padding: 20px; }

        /* --- 彈出視窗 (Modal) 樣式 --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content {
            background: #fff; 
            width: 95%; 
            max-width: 60rem; 
            max-height: 90vh;
            overflow-y: auto; padding: 2rem; border-radius: 4px; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
            flex-wrap: wrap; gap: 10px;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        
        .honor-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background-color: var(--badge-bg); color: var(--badge-text);
            padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 1rem;
        }
        .badge-icon { width: 18px; height: 18px; fill: currentColor; }

        .header-meta { color: #666; font-size: 0.95rem; }

        .close-btn {
            background: #fff; border: 1px solid #ccc; color: #333;
            padding: 5px 15px; border-radius: 4px; cursor: pointer;
            font-family: inherit; font-size: 0.95rem;
        }
        .close-btn:hover { background-color: #f0f0f0; }

        .modal-title-text {
            font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; line-height: 1.4;
        }
        .modal-body-text {
            font-size: 1.1rem; line-height: 1.8; color: #333; white-space: pre-wrap; margin-bottom: 30px;
            max-width: 100%;
        }

        .modal-photos-section { margin-top: 20px; }
        .photo-list { 
            list-style: none; padding: 0; margin: 15px 0 0 0; 
            display: flex; flex-wrap: wrap; gap: 15px;
        }
        .photo-item img {
            height: 150px; 
            width: auto; 
            max-width: 100%;
            border: 1px solid #ddd; 
            padding: 3px;
            object-fit: contain;
            transition: transform 0.2s, border-color 0.2s;
            background: #fff;
        }
        .photo-item img:hover {
            transform: scale(1.05); 
            border-color: var(--link-color);
            cursor: pointer;
        }

        /* ★★★ RWD 設定修正 (修復 iPad/手機 比例問題) ★★★ */
        @media (max-width: 768px) {
            .honor-item { flex-direction: column; }
            
            .honor-img-box {
                width: 100%; 
                height: auto; /* 高度自動，由 aspect-ratio 控制 */
                /* ★ 關鍵：使用 aspect-ratio 固定比例，iPad 上就不會變形 */
                aspect-ratio: 4 / 3; 
                margin-bottom: 10px; 
            }
            
            /* 確保按鈕和圖片都填滿這個 4:3 的框框 */
            .honor-img-box button.title-btn,
            .honor-thumb {
                width: 100%;
                height: 100%;
                object-fit: cover; /* 裁切多餘部分，確保填滿且不變形 */
                object-position: center top; /* 重點通常在上面 (人臉) */
                display: block;
            }
            
            .honor-meta { text-align: left; justify-content: flex-start; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; }
            .title-btn { font-size: 1.15rem; }
            
            .modal-content { padding: 1rem; }
            .modal-header { flex-direction: column; align-items: flex-start; }
            .header-left { width: 100%; flex-wrap: wrap; }
            .close-btn { align-self: flex-end; margin-top: -40px; } 
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <h1 class="sr-only">學校榮譽榜列表</h1>

        <div id="loading" role="status">↻ 榮譽榜載入中...</div>
        
        <nav id="filter-section" class="filter-section" aria-label="榮譽榜分類篩選">
            <span class="sr-only">分類選單載入中...</span>
        </nav>

        <nav aria-label="榮譽榜列表">
            <ul id="honor-list" class="honor-list"></ul>
        </nav>

        <nav aria-label="分頁導航">
            <div id="pagination" class="pagination"></div>
        </nav>
    </div>

    <div id="detail-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title-text">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-left">
                    <span class="honor-badge">
                        <svg class="badge-icon" viewBox="0 0 24 24"><path d="M20.2 2H3.8C2.8 2 2 2.8 2 3.8V5c0 1.1.9 2 2 2h.2c.5 3 2.5 5.4 5.3 6.4C10.2 16.2 12 17 12 17s1.8-.8 2.5-3.6c2.8-1 4.8-3.4 5.3-6.4h.2c1.1 0 2-.9 2-2V3.8c0-1-.8-1.8-1.8-1.8zM4 5V4h2v2c-1.1 0-2-.9-2-1zm14.2 8.4c-2.3.8-4 2.8-4.2 5.2h-4c-.2-2.4-1.9-4.4-4.2-5.2-.6-3.7-3.8-6.4-3.8-6.4V4h12v3c0 .1-3.2 2.8-3.8 6.4zM20 5c0 1.1-.9 2-2 2V4h2v1z"></path><path d="M6 19h12v2H6z"></path></svg>
                        榮譽榜公告
                    </span>
                    <div class="header-meta">
                        <span id="modal-dept"></span>
                        <span id="modal-date" style="margin-left: 10px;"></span>
                    </div>
                </div>
                <button id="modal-close-btn" class="close-btn" title="關閉視窗">關閉</button>
            </div>

            <h2 id="modal-title-text" class="modal-title-text">公告詳細內容</h2>
            
            <div id="modal-body-text" class="modal-body-text"></div>

            <div id="modal-photos" class="modal-photos-section" style="display:none;">
                <span class="honor-badge">
                    <svg class="badge-icon" viewBox="0 0 24 24"><path d="M20.2 2H3.8C2.8 2 2 2.8 2 3.8V5c0 1.1.9 2 2 2h.2c.5 3 2.5 5.4 5.3 6.4C10.2 16.2 12 17 12 17s1.8-.8 2.5-3.6c2.8-1 4.8-3.4 5.3-6.4h.2c1.1 0 2-.9 2-2V3.8c0-1-.8-1.8-1.8-1.8zM4 5V4h2v2c-1.1 0-2-.9-2-1zm14.2 8.4c-2.3.8-4 2.8-4.2 5.2h-4c-.2-2.4-1.9-4.4-4.2-5.2-.6-3.7-3.8-6.4-3.8-6.4V4h12v3c0 .1-3.2 2.8-3.8 6.4zM20 5c0 1.1-.9 2-2 2V4h2v1z"></path><path d="M6 19h12v2H6z"></path></svg>
                    競賽照片
                </span>
                <ul id="photo-list" class="photo-list"></ul>
            </div>
        </div>
    </div>

<script>
    const DATA_URL = "https://script.google.com/macros/s/AKfycbxlLrGfUegvnoHz7fyBSiytGI9LHF8e7NN9t9grpGV1j0hcRNhkLnMh4lLLRFAzFdv-9Q/exec"; // 請確認您的網址
    const ITEMS_PER_PAGE = 3; 

    // 分類設定
    const CAT_CONFIG = {
        "all": { name: "全部", color: "var(--cat-all-bg)" },
        "10": { name: "國際", color: "var(--cat-intl-bg)" }, 
        "20": { name: "全國", color: "var(--cat-nat-bg)" },
        "40": { name: "縣市", color: "var(--cat-city-bg)" },
        "50": { name: "區域", color: "var(--cat-dist-bg)" },
        "60": { name: "全校", color: "var(--cat-school-bg)" },
        "70": { name: "年級", color: "var(--cat-grade-bg)" },
        "99": { name: "民間", color: "var(--cat-private-bg)" }
    };

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let currentCategory = 'all';
    let lastFocusedElement = null;

    const listContainer = document.getElementById('honor-list');
    const loadingDiv = document.getElementById('loading');
    const paginationDiv = document.getElementById('pagination');
    const filterSection = document.getElementById('filter-section');

    const modal = document.getElementById('detail-modal');
    const modalTitleText = document.getElementById('modal-title-text');
    const modalDate = document.getElementById('modal-date');
    const modalDept = document.getElementById('modal-dept');
    const modalBodyText = document.getElementById('modal-body-text');
    const modalPhotos = document.getElementById('modal-photos');
    const photoList = document.getElementById('photo-list');
    const closeBtn = document.getElementById('modal-close-btn');

    fetch(DATA_URL)
        .then(res => res.json())
        .then(json => {
            loadingDiv.style.display = 'none';
            if (json.status !== "success" || !json.data || json.data.length === 0) {
                listContainer.innerHTML = "<div style='text-align:center; padding:20px'>無資料</div>";
                return;
            }
            allData = json.data;
            filteredData = allData;
            
            initFilters();
            renderPage(1);
        })
        .catch(err => {
            console.error(err);
            loadingDiv.innerHTML = "載入失敗";
        });

    function initFilters() {
        const counts = { "all": allData.length };
        
        allData.forEach(item => {
            if (item.category_id) {
                counts[item.category_id] = (counts[item.category_id] || 0) + 1;
            }
        });

        // 清空預設內容
        filterSection.innerHTML = "";

        createFilterBtn("all", counts["all"]);

        Object.keys(counts).forEach(catId => {
            if (catId !== "all" && CAT_CONFIG[catId]) {
                createFilterBtn(catId, counts[catId]);
            }
        });
    }

    function createFilterBtn(catId, count) {
        const config = CAT_CONFIG[catId] || { name: "其他", color: "#999" };
        const btn = document.createElement('button');
        btn.className = `filter-btn ${catId === 'all' ? '' : 'inactive'}`; 
        btn.style.backgroundColor = config.color;
        btn.title = `篩選分類：${config.name}`;
        btn.dataset.id = catId;
        
        btn.innerHTML = `${config.name} <span class="count-pill">${count}</span>`;
        
        btn.onclick = () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.add('inactive'));
            btn.classList.remove('inactive');
            applyFilter(catId);
        };
        
        filterSection.appendChild(btn);
    }

    function applyFilter(catId) {
        currentCategory = catId;
        if (catId === 'all') {
            filteredData = allData;
        } else {
            filteredData = allData.filter(item => item.category_id == catId);
        }
        renderPage(1);
    }

    function renderPage(page) {
        currentPage = page;
        listContainer.innerHTML = "";
        
        if (filteredData.length === 0) {
            listContainer.innerHTML = "<div style='text-align:center; padding:20px'>此分類無資料</div>";
            paginationDiv.innerHTML = "";
            return;
        }

        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = filteredData.slice(start, end);

        pageItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'honor-item';
            
            const d = item.date;
            const dateStr = d ? `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}` : '';
            const docNo = item.doc_no ? `文號: ${item.doc_no}` : '';
            
            const catConfig = CAT_CONFIG[item.category_id] || { name: item.category_name, color: "#999" };
            const catBadgeHtml = `<span class="cat-tag" style="background-color:${catConfig.color}; margin-right:5px;">${catConfig.name}</span>`;

            let imgHtml = '';
            if (item.images && item.images.length > 0) {
                // 按鈕點擊觸發彈窗
                imgHtml = `
                    <div class="honor-img-box">
                        <button class="title-btn" onclick="openDetails(${start + index})" title="查看詳情：${item.title}">
                            <img src="${item.images[0].url}" class="honor-thumb" alt="${item.title} 的活動照片">
                        </button>
                    </div>`;
            } else {
                imgHtml = `
                    <div class="honor-img-box" style="background:#f9f9f9; display:flex; align-items:center; justify-content:center; border:1px solid #ddd;">
                        <span style="color:#ccc;">無照片</span>
                    </div>`;
            }

            const contentId = `desc-${item.id}`;
            const btnId = `btn-${item.id}`;
            let descHtml = `<div id="${contentId}" class="honor-desc desc-truncated">${item.content}</div>`;
            let moreBtnHtml = `<button id="${btnId}" class="show-more-btn" onclick="toggleMore('${contentId}', '${btnId}')" aria-expanded="false" aria-controls="${contentId}" title="在列表中展開：${item.title}">顯示更多內容...</button>`;

            li.innerHTML = `
                ${imgHtml}
                <div class="honor-content-box">
                    <h2 class="honor-title">
                        <button class="title-btn" onclick="openDetails(${start + index})" title="查看詳情：${item.title}">
                            ${item.title}
                        </button>
                    </h2>
                    ${descHtml}
                    ${moreBtnHtml}
                    <div class="honor-meta">
                        ${catBadgeHtml}
                        <span class="meta-tag"><span class="sr-only">文號：</span>${docNo}</span>
                        <span class="meta-tag"><span class="sr-only">發布單位：</span>${item.dept}</span>
                        <span class="meta-tag"><span class="sr-only">發布日期：</span>${dateStr}</span>
                    </div>
                </div>
            `;
            listContainer.appendChild(li);
        });

        renderPagination();
        window.scrollTo(0, 0);
    }

    function toggleMore(contentId, btnId) {
        const content = document.getElementById(contentId);
        const btn = document.getElementById(btnId);
        if (content.classList.contains('desc-truncated')) {
            content.classList.remove('desc-truncated');
            btn.style.display = 'none';
            btn.setAttribute('aria-expanded', 'true');
        }
    }

    window.openDetails = function(index) {
        const item = filteredData[index];
        lastFocusedElement = document.activeElement;
        
        modalTitleText.textContent = item.title;
        modalBodyText.textContent = item.content;
        
        const d = item.date;
        const dateStr = d ? `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}` : '';
        modalDate.textContent = dateStr;
        modalDept.textContent = item.dept;

        if (item.images && item.images.length > 0) {
            modalPhotos.style.display = 'block';
            photoList.innerHTML = item.images.map(img => `
                <li class="photo-item">
                    <a href="${img.url}" target="_blank" download title="下載原圖：${item.title}">
                        <img src="${img.url}" alt="競賽照片：${item.title}">
                    </a>
                </li>
            `).join('');
        } else {
            modalPhotos.style.display = 'none';
        }

        modal.style.display = 'flex';
        closeBtn.focus(); 
        document.body.style.overflow = 'hidden'; 
    };

    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

    function renderPagination() {
        paginationDiv.innerHTML = "";
        const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        
        if (totalPages <= 1) return;

        const pagesPerGroup = 10;
        const currentGroup = Math.ceil(currentPage / pagesPerGroup);
        const startPage = (currentGroup - 1) * pagesPerGroup + 1;
        const endPage = Math.min(startPage + pagesPerGroup - 1, totalPages);

        if (startPage > 1) {
             const prevGroupBtn = document.createElement('button');
             prevGroupBtn.className = 'page-btn';
             prevGroupBtn.innerText = "<<"; 
             prevGroupBtn.title = "上10頁";
             prevGroupBtn.setAttribute('aria-label', '上10頁');
             prevGroupBtn.onclick = () => renderPage(startPage - 1); 
             paginationDiv.appendChild(prevGroupBtn);
        }

        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerText = "<";
        prevBtn.title = "上一頁";
        prevBtn.disabled = currentPage === 1;
        prevBtn.setAttribute('aria-label', '上一頁');
        prevBtn.onclick = () => renderPage(currentPage - 1);
        paginationDiv.appendChild(prevBtn);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.innerText = i;
            btn.title = `前往第 ${i} 頁`;
            btn.setAttribute('aria-label', `第 ${i} 頁`);
            if(i === currentPage) btn.setAttribute('aria-current', 'page');
            btn.onclick = () => renderPage(i);
            paginationDiv.appendChild(btn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerText = ">";
        nextBtn.title = "下一頁";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.setAttribute('aria-label', '下一頁');
        nextBtn.onclick = () => renderPage(currentPage + 1);
        paginationDiv.appendChild(nextBtn);

        if (endPage < totalPages) {
             const nextGroupBtn = document.createElement('button');
             nextGroupBtn.className = 'page-btn';
             nextGroupBtn.innerText = ">>"; 
             nextGroupBtn.title = "下10頁";
             nextGroupBtn.setAttribute('aria-label', '下10頁');
             nextGroupBtn.onclick = () => renderPage(endPage + 1); 
             paginationDiv.appendChild(nextGroupBtn);
        }
    }
</script>

</body>
</html>