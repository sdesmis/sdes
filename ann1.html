<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ ¡åœ’è³‡è¨Šç¶²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">

  <style>
    /* ========== åŸºç¤è®Šæ•¸ ========== */
    :root { 
      --bg: #ffffff; --text: #333; --primary: #00695c; --secondary: #e0f2f1;
      --border: #ddd; --input-bg: #f9f9f9; --theme-color: #00695c; --btn-text: #fff;
      --gray-border: #ccc;
    }
    * { box-sizing: border-box; }
    html, body { font-family: "Iansui", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.6; }
    
    button, input, select, textarea, .btn { font-family: inherit; }

    /* ========== Layout: Grid 3 Columns ========== */
    .site-container {
      display: grid;
      grid-template-areas: "header" "nav" "content" "footer";
      grid-template-columns: 1fr;
      min-height: 100vh;
      width: 100%;
      margin: 0 auto;
      background: #fff;
    }

    /* é›»è…¦ç‰ˆä½ˆå±€ */
    @media (min-width: 992px) {
      .site-container {
        grid-template-areas: 
          "header header header"
          "nav nav nav"
          "left main right"
          "footer footer footer";
        
        /* é è¨­ï¼šå¯¬ç‰ˆ (Wide) 3:7:3 */
        grid-template-columns: 3fr 7fr 3fr;
        max-width: 98%; 
        box-shadow: 0 0 1.25rem rgba(0,0,0,0.1);
      }

      /* é¸é …ï¼šçª„ç‰ˆ (Boxed) */
      .site-container.layout-boxed {
        max-width: 80rem; /* ç´„ 1280px */
        /* å·¦å³å›ºå®šç´„ 256px (16rem)ï¼Œä¸­é–“è‡ªé©æ‡‰ */
        grid-template-columns: 16rem 1fr 16rem; 
      }
    }

    /* Header */
    #site-header { grid-area: header; background: #fff; padding: 1.5rem 2rem; border-bottom: 0.3rem solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
    .school-title h1 { margin: 0; color: var(--primary); font-size: 2.2rem; }
    .school-title p { margin: 0; color: #666; font-size: 1.1rem; }

    /* Nav */
    #site-nav { grid-area: nav; background: var(--primary); color: #fff; }
    #site-nav ul { list-style: none; margin: 0; padding: 0; display: flex; flex-wrap: wrap; }
    #site-nav li a { display: block; padding: 1rem 1.5rem; color: #fff; text-decoration: none; font-weight: bold; transition:0.3s; cursor: pointer; }
    #site-nav li a:hover, #site-nav li a.active { background: rgba(255,255,255,0.2); }

    /* Content Areas */
    #main-content { grid-area: main; padding: 1.25rem; background: #fff; }
    #sidebar-left { grid-area: left; padding: 1.25rem; background: #fdfdfd; border-right: 1px solid var(--border); }
    #sidebar-right { grid-area: right; padding: 1.25rem; background: #fdfdfd; border-left: 1px solid var(--border); }

    /* Widgets */
    .widget { margin-bottom: 1.25rem; border: 1px solid var(--border); border-radius: 0.5rem; overflow: hidden; background: #fff; }
    .widget-title { background: var(--primary); color: #fff; padding: 0.6rem 1rem; margin: 0; font-size: 1.1rem; }
    .widget-body { padding: 1rem; }
    .widget-list { list-style: none; padding: 0; margin: 0; }
    .widget-list li { margin-bottom: 0.5rem; border-bottom: 1px dashed #eee; padding-bottom: 0.3rem; }
    .widget-list a { color: #333; text-decoration: none; }
    .widget-list a:hover { color: var(--primary); text-decoration: underline; }
    iframe { width: 100%; border: 0; }

    /* Footer */
    #site-footer { grid-area: footer; background: #333; color: #ccc; text-align: center; padding: 2rem; margin-top: auto; }

    /* Admin specific */
    .admin-mode .site-container { display: block; max-width: 100% !important; }
    .admin-mode #sidebar-left, .admin-mode #sidebar-right { display: none; }
    
    /* UI Elements */
    .btn { padding: 0.5rem 1rem; background: var(--primary); color: #fff; border: none; border-radius: 0.25rem; cursor: pointer; text-decoration: none; display: inline-block; font-size: 1rem; margin-right: 0.3rem; }
    .btn:hover { opacity: 0.9; }
    .btn-sec { background: transparent; color: #333; border: 1px solid #ccc; }
    .btn-danger { background: #d32f2f; }
    input, select, textarea { width: 100%; padding: 0.5rem; margin-bottom: 0.6rem; border: 1px solid #ddd; border-radius: 0.25rem; }
    
    /* å…¬å‘Šèˆ‡æ¦®è­½æ¦œ */
    .post-list-item { padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
    .post-list-item:hover { background: #f5f5f5; }
    .badge-pin { background: #d32f2f; color: #fff; padding: 0.1rem 0.3rem; font-size: 0.8rem; border-radius: 0.2rem; margin-right: 0.3rem; }
    
    /* Honor Roll Styles */
    #honor-roll-section { margin-top: 1.5rem; margin-bottom: 3rem; border: 1px solid var(--gray-border); border-radius: 0.5rem; overflow: hidden; display: none; box-shadow: 0 0.125rem 0.3rem rgba(0,0,0,0.05); }
    #honor-roll-header { background: #f5f5f5; color: #333; padding: 0.6rem 1rem; font-size: 1.3rem; font-weight: bold; border-bottom: 1px solid var(--gray-border); }
    .honor-card { display: flex; flex-wrap: wrap; background: #fff; border-bottom: 1px solid var(--gray-border); }
    .honor-card:last-child { border-bottom: none; }
    .honor-media { flex: 0 0 350px; max-width: 100%; min-height: 250px; background: #f9f9f9; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .honor-media img { width: 100%; height: 250px; object-fit: contain; background: #f0f0f0; }
    .honor-content { flex: 1; padding: 1.25rem; display: flex; flex-direction: column; justify-content: center; }
    .honor-content h3 { margin: 0 0 0.6rem 0; font-size: 1.5rem; }
    
    .carousel-controls { position: absolute; bottom: 0.6rem; left: 0.6rem; display: flex; gap: 0.3rem; background: rgba(0,0,0,0.6); padding: 0.3rem 0.6rem; border-radius: 1.25rem; }
    .carousel-btn { background: transparent; color: #fff; border: 1px solid #fff; width: 1.8rem; height: 1.8rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; padding: 0; }
    .carousel-btn:hover { background: #fff; color: #000; }
    .ctrl-prev { order: 1; } .ctrl-play { order: 2; } .ctrl-next { order: 3; }

    /* Pagination */
    .pagination { display: flex; justify-content: center; gap: 0.3rem; margin-top: 1.25rem; padding-bottom: 1.25rem; }
    .page-btn { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-border); background: #fff; cursor: pointer; border-radius: 0.25rem; }
    .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* Dialog */
    dialog { border: 2px solid #ccc; border-radius: 0.5rem; padding: 1.25rem; max-width: 40rem; width: 90%; }
    dialog::backdrop { background: rgba(0,0,0,0.5); }
    
    /* RWD */
    @media(max-width:768px){ .site-container{grid-template-areas:"header" "nav" "left" "main" "right" "footer"; grid-template-columns:1fr;} .honor-card{flex-direction:column;} .honor-media{flex:auto;width:100%;} #site-nav ul{flex-direction:column;} #site-nav li a{border-bottom:1px solid rgba(255,255,255,0.1);} }
    .cat-disabled { text-decoration: line-through; color: #888; }
    .view { display: none; } 
    .active-view { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<div id="site-container" class="site-container">
  
  <header id="site-header">
    <div class="school-title">
      <h1 id="header-name-zh">è¼‰å…¥ä¸­...</h1>
      <p id="header-name-en">Loading...</p>
    </div>
    <div>
      <button onclick="showLogin()" class="btn btn-sec" id="btn-login-toggle" title="é»æ“Šç™»å…¥æ•™è·å“¡ç³»çµ±">æ•™è·å“¡ç™»å…¥</button>
    </div>
  </header>

  <nav id="site-nav">
    <ul id="nav-list">
      </ul>
  </nav>

  <aside id="sidebar-left">
    </aside>

  <main id="main-content">
    
    <div id="view-home" class="view active-view">
      
      <h2 style="border-bottom:0.125rem solid var(--primary); padding-bottom:0.6rem; margin-top:0;">æœ€æ–°æ¶ˆæ¯</h2>
      <div style="margin-bottom:1rem;">
        <label for="cat-filter">åˆ†é¡ç¯©é¸ï¼š</label>
        <select id="cat-filter" onchange="applyFilter()" title="é¸æ“‡å…¬å‘Šåˆ†é¡">
          <option value="all">æ‰€æœ‰åˆ†é¡</option>
        </select>
      </div>
      <div id="post-list">
        <p style="padding: 1.25rem;">è³‡æ–™è¼‰å…¥ä¸­...</p>
      </div>
      <div id="pagination" class="pagination"></div>

      <section id="honor-roll-section" aria-label="æ¦®è­½æ¦œ">
        <div id="honor-roll-header">ğŸ† å¸«ç”Ÿæ¦®è­½æ¦œ</div>
        <div id="honor-list"></div>
        <div id="honor-pagination" class="pagination"></div>
      </section>
    </div>

    <div id="view-about" class="view"><h2>å­¸æ ¡ç°¡ä»‹</h2><p>é€™è£¡æ˜¯å­¸æ ¡ç°¡ä»‹å…§å®¹...</p></div>
    <div id="view-admin-unit" class="view"><h2>è¡Œæ”¿å–®ä½</h2><p>å„è™•å®¤ä»‹ç´¹...</p></div>
    <div id="view-resources" class="view"><h2>æ•™å­¸è³‡æº</h2><p>å­¸ç¿’è³‡æº...</p></div>
    <div id="view-contact" class="view"><h2>è¯çµ¡æˆ‘å€‘</h2><p>æ ¡å€èˆ‡é›»è©±...</p></div>

    <div id="view-login" class="view">
      <h2 style="text-align:center;">æ•™è·å“¡ç™»å…¥</h2>
      <form onsubmit="handleLogin(event)" style="max-width:20rem; margin:0 auto; border:1px solid #ccc; padding:1.25rem; border-radius:0.5rem;">
        <label for="username">å¸³è™Ÿ</label>
        <input type="text" id="username" required title="è«‹è¼¸å…¥å¸³è™Ÿ">
        
        <label for="password">å¯†ç¢¼</label>
        <input type="password" id="password" required title="è«‹è¼¸å…¥å¯†ç¢¼">
        
        <div style="margin-top:0.6rem; display:flex; justify-content:space-between;">
          <button type="submit" class="btn" title="åŸ·è¡Œç™»å…¥">ç™»å…¥</button>
          <button type="button" class="btn btn-sec" onclick="switchView('view-home')" title="è¿”å›é¦–é ">å–æ¶ˆ</button>
        </div>
      </form>
    </div>

    <div id="view-admin" class="view">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; border-bottom:1px solid #eee; padding-bottom:0.6rem;">
        <h3>å¾Œå°ç®¡ç† - <span id="admin-user-display"></span></h3>
        <div>
          <button onclick="goHome()" class="btn btn-sec" title="å›åˆ°å‰å°é¦–é ">å›é¦–é </button>
          <button onclick="openChangePasswordModal()" class="btn btn-sec" title="ä¿®æ”¹å€‹äººå¯†ç¢¼">æ”¹å¯†ç¢¼</button>
          <button onclick="logout()" class="btn btn-danger" title="ç™»å‡ºç³»çµ±">ç™»å‡º</button>
        </div>
      </div>

      <div style="margin-bottom:1.25rem;">
        <button onclick="switchAdminTab('tab-posts')" class="btn" title="åˆ‡æ›åˆ°å…¬å‘Šç®¡ç†">å…¬å‘Šç®¡ç†</button>
        <button onclick="switchAdminTab('tab-site')" class="btn btn-sec" title="åˆ‡æ›åˆ°ç¶²ç«™æ¶æ§‹">ç¶²ç«™æ¶æ§‹</button>
        <button onclick="switchAdminTab('tab-users')" class="btn btn-sec" title="åˆ‡æ›åˆ°ä½¿ç”¨è€…è¨­å®š">ä½¿ç”¨è€…/è¨­å®š</button>
      </div>

      <div id="tab-posts" class="admin-tab">
        <div style="background:#f9f9f9; padding:1.25rem; border-radius:0.5rem; margin-bottom:1.25rem;">
          <h4>ç™¼å¸ƒå…¬å‘Š</h4>
          <form onsubmit="handlePostSave(event)">
            <input type="hidden" id="p-id">
            
            <label for="p-title">æ¨™é¡Œ</label>
            <input type="text" id="p-title" placeholder="æ¨™é¡Œ" required title="è«‹è¼¸å…¥å…¬å‘Šæ¨™é¡Œ">
            
            <div style="display:flex; gap:0.6rem;">
              <div style="flex:1;">
                <label for="p-cat">åˆ†é¡</label>
                <select id="p-cat" required title="é¸æ“‡å…¬å‘Šåˆ†é¡"><option>åˆ†é¡...</option></select>
              </div>
              <div style="flex:1;">
                <label for="p-author">ç™¼å¸ƒè€…</label>
                <select id="p-author" title="é¸æ“‡ç™¼å¸ƒè€…(é¸å¡«)"><option value="">ç™¼å¸ƒè€…(é¸å¡«)</option></select>
              </div>
            </div>
            
            <label for="p-content">å…§å®¹</label>
            <textarea id="p-content" rows="5" placeholder="å…§å®¹" required title="è«‹è¼¸å…¥å…¬å‘Šå…§å®¹"></textarea>
            
            <div style="background:#fff; padding:0.6rem; border:1px dashed #ccc; margin-bottom:0.6rem;">
              <label for="p-file">é™„ä»¶ (å¤šé¸)ï¼š</label>
              <input type="file" id="p-file" multiple title="ä¸Šå‚³é™„ä»¶æª”æ¡ˆ">
              <div id="curr-attach" style="display:none; font-size:0.9rem; color:#666;">
                ç¾æœ‰ï¼š<span id="exist-file-list"></span>
                <label style="color:#b00; margin-left:0.6rem;" for="del-attach">
                  <input type="checkbox" id="del-attach" title="å‹¾é¸åˆªé™¤èˆŠé™„ä»¶"> åˆªé™¤èˆŠæª”
                </label>
              </div>
            </div>

            <div style="display:flex; gap:1rem; margin-bottom:0.6rem;">
              <label for="p-top"><input type="checkbox" id="p-top" title="è¨­ç‚ºç½®é ‚"> ç½®é ‚</label>
              <label for="p-pin-exp">æœŸé™ï¼š<input type="date" id="p-pin-exp" title="ç½®é ‚æœŸé™"></label>
              <label for="p-exp">ä¸‹æ¶ï¼š<input type="date" id="p-exp" title="ä¸‹æ¶æ—¥æœŸ"></label>
              <label for="p-link">å¤–é€£ï¼š<input type="url" id="p-link" placeholder="http://" title="å¤–éƒ¨é€£çµç¶²å€"></label>
            </div>
            <button type="submit" class="btn" title="å„²å­˜å…¬å‘Š">å„²å­˜</button> 
            <button type="button" onclick="resetPostForm()" class="btn btn-sec" title="æ¸…ç©ºè¡¨å–®">æ¸…ç©º</button>
          </form>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead><tr style="background:#eee;"><th style="border:1px solid #ccc;padding:0.5rem;">æ—¥æœŸ</th><th>æ¨™é¡Œ</th><th>åˆ†é¡</th><th>ç™¼å¸ƒè€…</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="admin-post-list"></tbody>
          </table>
        </div>
        <div id="admin-pagination" class="pagination"></div>
      </div>

      <div id="tab-site" class="admin-tab" style="display:none;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.25rem;">
          <div style="border:1px solid #ddd; padding:1rem; border-radius:0.5rem;">
            <h4>å°è¦½åˆ—ç®¡ç†</h4>
            <form onsubmit="handleNavSave(event)">
              <input type="hidden" id="nav-id">
              <label for="nav-title">åç¨±</label>
              <input type="text" id="nav-title" placeholder="åç¨±" required title="è¼¸å…¥é¸å–®åç¨±">
              
              <label for="nav-link">é€£çµ</label>
              <input type="text" id="nav-link" placeholder="é€£çµ URL" required title="è¼¸å…¥é¸å–®é€£çµ">
              
              <label for="nav-order">æ’åº</label>
              <input type="number" id="nav-order" placeholder="æ’åº" required style="width:5rem;" title="è¼¸å…¥æ’åºæ•¸å­—">
              
              <button type="submit" class="btn" title="æ–°å¢æˆ–æ›´æ–°å°è¦½åˆ—">å„²å­˜</button>
            </form>
            <ul id="admin-nav-list" style="margin-top:1rem; padding-left:1.25rem;"></ul>
          </div>
          <div style="border:1px solid #ddd; padding:1rem; border-radius:0.5rem;">
            <h4>å´é‚Šæ¬„å€å¡Šç®¡ç†</h4>
            <form onsubmit="handleWidgetSave(event)">
              <input type="hidden" id="wid-id">
              
              <label for="wid-title">æ¨™é¡Œ</label>
              <input type="text" id="wid-title" placeholder="å€å¡Šæ¨™é¡Œ" required title="è¼¸å…¥å€å¡Šæ¨™é¡Œ">
              
              <label for="wid-type">é¡å‹</label>
              <select id="wid-type" onchange="toggleWidInput()" title="é¸æ“‡å€å¡Šå…§å®¹é¡å‹">
                <option value="links">é€£çµåˆ—è¡¨</option>
                <option value="html">è‡ªè¨‚ HTML/Iframe</option>
              </select>
              
              <label for="wid-pos">ä½ç½®</label>
              <select id="wid-pos" title="é¸æ“‡é¡¯ç¤ºä½ç½®"><option value="left">å·¦å´æ¬„</option><option value="right">å³å´æ¬„</option></select>
              
              <label for="wid-order">æ’åº</label>
              <input type="number" id="wid-order" placeholder="æ’åº" required style="width:5rem;" title="è¼¸å…¥æ’åºæ•¸å­—">
              
              <div id="wid-input-links">
                <p style="font-size:0.8rem; color:#666; margin:0.3rem 0;">æ ¼å¼ï¼šæ¨™é¡Œ|ç¶²å€ (æ¯è¡Œä¸€å€‹)</p>
                <label for="wid-content-links" style="display:none;">é€£çµå…§å®¹</label>
                <textarea id="wid-content-links" rows="4" placeholder="æ•™è‚²éƒ¨|http://..." title="è¼¸å…¥é€£çµåˆ—è¡¨"></textarea>
              </div>
              <div id="wid-input-html" style="display:none;">
                <label for="wid-content-html" style="display:none;">HTMLå…§å®¹</label>
                <textarea id="wid-content-html" rows="4" placeholder="HTML ä»£ç¢¼" title="è¼¸å…¥HTMLä»£ç¢¼"></textarea>
              </div>
              <button type="submit" class="btn" title="æ–°å¢æˆ–æ›´æ–°å€å¡Š">å„²å­˜</button>
            </form>
            <ul id="admin-wid-list" style="margin-top:1rem; padding-left:1.25rem;"></ul>
          </div>
        </div>
        <div style="margin-top:1.25rem; border:1px solid #ddd; padding:1rem; border-radius:0.5rem;">
          <h4>åˆ†é¡ç®¡ç† (åœç”¨/å•Ÿç”¨)</h4>
          <form onsubmit="handleCatSave(event)" style="display:flex; gap:0.6rem; margin-bottom:0.6rem;">
            <input type="hidden" id="cat-id">
            <label for="cat-name" style="display:none;">åˆ†é¡åç¨±</label>
            <input type="text" id="cat-name" placeholder="åˆ†é¡åç¨±" required title="è¼¸å…¥åˆ†é¡åç¨±">
            <button type="submit" class="btn" title="å„²å­˜åˆ†é¡">å„²å­˜</button>
          </form>
          <table style="width:100%; border-collapse:collapse;"><tbody id="cat-tbody"></tbody></table>
        </div>
      </div>

      <div id="tab-users" class="admin-tab" style="display:none;">
        <div style="background:#fff3e0; padding:1rem; border-radius:0.5rem; margin-bottom:1.25rem;">
          <h4>å…¨ç«™è¨­å®š</h4>
          <label for="set-name-zh">ä¸­æ–‡æ ¡å</label>
          <input type="text" id="set-name-zh" title="è¼¸å…¥ä¸­æ–‡æ ¡å">
          
          <label for="set-name-en">è‹±æ–‡æ ¡å</label>
          <input type="text" id="set-name-en" title="è¼¸å…¥è‹±æ–‡æ ¡å">
          
          <label for="set-color">ä¸»é¡Œè‰²</label>
          <input type="color" id="set-color" title="é¸æ“‡ç¶²ç«™ä¸»é¡Œè‰²">
          
          <div style="margin-top:0.6rem; padding-top:0.6rem; border-top:1px dashed #ccc;">
            <label for="set-layout-mode">ç‰ˆé¢å¯¬åº¦ï¼š</label>
            <select id="set-layout-mode" style="width:auto; display:inline-block;" title="é¸æ“‡ç‰ˆé¢å¯¬åº¦">
              <option value="wide">å¯¬ç‰ˆ (é è¨­)</option>
              <option value="boxed">çª„ç‰ˆ</option>
            </select>
          </div>

          <button onclick="saveSiteSettings()" class="btn" style="margin-top:0.6rem;" title="å„²å­˜ç³»çµ±è¨­å®š">å„²å­˜è¨­å®š</button>
        </div>
        
        <div style="background:#f9f9f9; padding:1.25rem; border-radius:0.5rem;">
          <h4>ä½¿ç”¨è€…ç®¡ç†</h4>
          <form id="user-form" onsubmit="handleUserSave(event)">
            <input type="hidden" id="user-is-edit" value="false">
            
            <label for="new-username">å¸³è™Ÿ (å¿…å¡«)</label>
            <input type="text" id="new-username" required title="è¼¸å…¥ä½¿ç”¨è€…å¸³è™Ÿ">
            
            <label for="new-jobtitle">è·ç¨± (å¿…å¡«)</label>
            <input type="text" id="new-jobtitle" required title="è¼¸å…¥è·ç¨±">
            
            <label for="new-password">å¯†ç¢¼ (æ–°å¢å¿…å¡«ï¼Œ8-20å­—å…ƒ)</label>
            <input type="password" id="new-password" title="è¼¸å…¥å¯†ç¢¼">
            
            <div style="background:#fff; padding:0.6rem; border:1px solid #ddd; margin:0.6rem 0;">
              <p style="margin:0 0 0.3rem 0;"><strong>æ¬Šé™ï¼š</strong></p>
              <label for="role-super"><input type="checkbox" id="role-super" title="è¨­å®šç‚ºç³»çµ±ç®¡ç†å“¡"> ç³»çµ±ç®¡ç†å“¡</label>
              <hr style="margin:0.3rem 0;">
              <label style="color:#0056b3;" for="perm-select-all">
                <input type="checkbox" id="perm-select-all" onchange="toggleAllPerms(this)" title="å…¨é¸æ‰€æœ‰åˆ†é¡æ¬Šé™"> å…¨é¸
              </label>
              <div id="permission-checkboxes" style="display:flex; flex-wrap:wrap; gap:0.6rem; margin-top:0.3rem;"></div>
            </div>
            <button type="submit" class="btn" title="å„²å­˜ä½¿ç”¨è€…è³‡æ–™">å„²å­˜ä½¿ç”¨è€…</button> 
            <button type="button" onclick="resetUserForm()" class="btn btn-sec" title="é‡ç½®è¡¨å–®">é‡ç½®</button>
          </form>
          <table style="width:100%; margin-top:1rem; border-collapse:collapse;"><tbody id="user-tbody"></tbody></table>
        </div>
      </div>

    </div>
  </main>

  <aside id="sidebar-right">
    </aside>

  <footer id="site-footer">
    <p>&copy; 2026 æ ¡åœ’è³‡è¨Šç¶²</p>
  </footer>

</div>

<div id="global-status" style="position:fixed; top:0.6rem; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:0.6rem 1.25rem; border-radius:0.25rem; display:none; z-index:9999;"></div>

<dialog id="detail-modal">
  <div style="text-align:right;"><button onclick="closeDetail()" class="btn btn-sec" title="é—œé–‰è¦–çª—">Close</button></div>
  <div id="modal-content"></div>
</dialog>

<dialog id="password-modal">
  <h3>ä¿®æ”¹å¯†ç¢¼</h3>
  <form onsubmit="handleChangePassword(event)">
    <label for="cp-old">èˆŠå¯†ç¢¼</label>
    <input type="password" id="cp-old" required title="è¼¸å…¥èˆŠå¯†ç¢¼">
    
    <label for="cp-new">æ–°å¯†ç¢¼ (8-20å­—)</label>
    <input type="password" id="cp-new" required title="è¼¸å…¥æ–°å¯†ç¢¼">
    
    <label for="cp-confirm">ç¢ºèª</label>
    <input type="password" id="cp-confirm" required title="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
    
    <button type="submit" class="btn" title="ç¢ºèªä¿®æ”¹">ä¿®æ”¹</button> 
    <button type="button" onclick="document.getElementById('password-modal').close()" class="btn btn-sec" title="å–æ¶ˆ">å–æ¶ˆ</button>
  </form>
</dialog>

<script>
// ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹å‹™å¿…æ›¿æ›æˆæ‚¨çš„ GAS ç¶²å€ ğŸ‘‡ğŸ‘‡ğŸ‘‡
const API_URL = "https://script.google.com/macros/s/AKfycbwhmKijh5AMO4g-fKpvA2kP3Jbe0RoHok-R3OYEtNqwZ8V35ykdZmvchMrsi8OaX-RF/exec";

// Global Variables
let siteData = {}, allPosts = [], currentUser = null;
let currentFilteredData = [];
const ITEMS_PER_PAGE = 5; let currentPage = 1;
const ADMIN_PER_PAGE = 10; let currentAdminPage = 1;
let honorData = []; const HONOR_PER_PAGE = 3; let currentHonorPage = 1;
const carouselTimers = {}; 

document.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    await Promise.all([loadSiteData(), loadPosts()]);
  } catch (error) {
    console.error("Init Error:", error);
    const list = document.getElementById('post-list');
    if(list) list.innerHTML = `<p style="color:red;padding:1.25rem;">é€£ç·šéŒ¯èª¤ï¼š${error.message}<br>è«‹ç¢ºèªå¾Œç«¯ç¨‹å¼ç¢¼å·²éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬ã€‚</p>`;
  }
}

async function loadSiteData() {
  const res = await fetch(`${API_URL}?op=getSiteData`);
  siteData = await res.json();
  if(siteData.error) throw new Error(siteData.error);
  renderSite();
}

async function loadPosts() {
  const res = await fetch(`${API_URL}?op=getPublicData`);
  allPosts = await res.json();
  if(allPosts.error) throw new Error(allPosts.error);
  applyFilter();
  initHonorRoll();
}

// ========== æ ¸å¿ƒï¼šæ¸²æŸ“å‰ç«¯ä»‹é¢ (åŠ å…¥é˜²å‘†) ==========
function renderSite() {
  // 1. è¨­å®š Header (é˜²å‘†ï¼šæª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨)
  const nameZH = document.getElementById('header-name-zh');
  const nameEN = document.getElementById('header-name-en');
  if(nameZH && siteData.settings) nameZH.textContent = siteData.settings.schoolNameZH || "å­¸æ ¡åç¨±";
  if(nameEN && siteData.settings) nameEN.textContent = siteData.settings.schoolNameEN || "School Name";
  if(siteData.settings && siteData.settings.themeColor) document.documentElement.style.setProperty('--primary', siteData.settings.themeColor);
  
  // Layout Mode Logic (Default: Wide)
  const container = document.getElementById('site-container');
  if(container) {
    // å¦‚æœå¾Œå°è¨­å®šæ˜¯ boxedï¼Œæ‰åŠ ä¸Š layout-boxed class
    // è‹¥æ²’æœ‰è¨­å®šï¼Œæˆ–è€…è¨­å®šæ˜¯ wideï¼Œå‰‡ç§»é™¤ layout-boxed (ç¶­æŒé è¨­çš„å¯¬ç‰ˆ)
    if(siteData.settings && siteData.settings.layoutMode === 'boxed') {
      container.classList.add('layout-boxed');
    } else {
      container.classList.remove('layout-boxed');
    }
  }

  // 2. æ¸²æŸ“ Nav (å°è¦½åˆ—)
  const navList = document.getElementById('nav-list');
  if(navList) {
    const items = siteData.navbar || [];
    navList.innerHTML = `<li><a onclick="switchView('view-home')" class="active">é¦–é </a></li>` + 
      items.map(n => `<li><a href="${n.link}" target="_blank">${n.title}</a></li>`).join('');
  }

  // 3. æ¸²æŸ“ Sidebar (å´é‚Šæ¬„)
  const left = document.getElementById('sidebar-left'), right = document.getElementById('sidebar-right');
  if(left) left.innerHTML = ''; 
  if(right) right.innerHTML = '';
  
  (siteData.sidebar || []).forEach(w => {
    let html = '';
    if(w.type === 'links') {
      try { html = '<ul class="widget-list">' + JSON.parse(w.content).map(l=>`<li><a href="${l.url}" target="_blank">${l.label}</a></li>`).join('') + '</ul>'; } catch(e){html='(é€£çµæ ¼å¼éŒ¯èª¤)';}
    } else html = w.content; // HTML/Iframe
    
    const widget = `<div class="widget"><div class="widget-title">${w.title}</div><div class="widget-body">${html}</div></div>`;
    if(w.pos === 'left' && left) left.innerHTML += widget; 
    else if(right) right.innerHTML += widget;
  });

  // 4. æ¸²æŸ“åˆ†é¡ä¸‹æ‹‰é¸å–®
  const cats = siteData.categories || [];
  const opts = cats.filter(c=>c.isActive).map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  
  const filter = document.getElementById('cat-filter');
  if(filter) filter.innerHTML = `<option value="all">æ‰€æœ‰åˆ†é¡</option>` + opts;
  
  const adminCat = document.getElementById('p-cat');
  if(adminCat) adminCat.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + opts;
  
  // 5. å¾Œå°åˆ†é¡åˆ—è¡¨
  const catTable = document.getElementById('cat-tbody');
  if(catTable) {
    catTable.innerHTML = cats.map(c => 
      `<tr>
        <td style="border:1px solid #ddd;padding:0.5rem;"><span class="${c.isActive?'':'cat-disabled'}">${c.name}</span></td>
        <td style="border:1px solid #ddd;padding:0.5rem;">
          <button onclick="editCat('${c.id}','${c.name}')" class="btn btn-sec" title="ç·¨è¼¯åˆ†é¡">ä¿®</button> 
          <button onclick="toggleCat('${c.id}',${!c.isActive})" class="btn ${c.isActive?'btn-danger':'btn'}" title="åˆ‡æ›ç‹€æ…‹">${c.isActive?'åœ':'å•Ÿ'}</button>
          <button onclick="deleteItem('deleteCategory','${c.id}')" class="btn btn-sec" title="åˆªé™¤åˆ†é¡">åˆª</button>
        </td>
      </tr>`
    ).join('');
  }
}

// ========== åœ–ç‰‡è™•ç† ==========
function getDriveImgUrl(url) {
  if (!url) return "";
  let id = ""; if (url.includes("id=")) id = url.split("id=")[1].split("&")[0]; else if (url.includes("/d/")) id = url.split("/d/")[1].split("/")[0];
  return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w2000` : url;
}

// ========== æ¦®è­½æ¦œé‚è¼¯ ==========
function initHonorRoll() {
  honorData = allPosts.filter(d => d.category && d.category.indexOf("æ¦®è­½æ¦œ") !== -1);
  const sec = document.getElementById('honor-roll-section');
  if(!sec) return;
  if(honorData.length > 0) {
    sec.style.display = 'block';
    renderHonorRollPage();
  } else {
    sec.style.display = 'none';
  }
}

function renderHonorRollPage() {
  Object.keys(carouselTimers).forEach(k => { clearInterval(carouselTimers[k]); delete carouselTimers[k]; });
  const start = (currentHonorPage-1)*HONOR_PER_PAGE;
  const list = document.getElementById('honor-list');
  if(!list) return;

  list.innerHTML = honorData.slice(start, start+HONOR_PER_PAGE).map((item) => {
    const key = item.id;
    const imgs = (item.attachments||[]).filter(f=>f.name.match(/\.(jpg|png|jpeg|webp)$/i));
    let media = `<div style="color:#ccc;font-size:3rem;text-align:center;line-height:200px;">ğŸ†</div>`;
    
    if(imgs.length===1) media = `<img src="${getDriveImgUrl(imgs[0].url)}" alt="${imgs[0].name}">`;
    else if(imgs.length>1) {
      const pImgs = imgs.map(i=>({url:getDriveImgUrl(i.url), name:i.name}));
      media = `<img src="${pImgs[0].url}" id="img-${key}" data-idx="0" alt="${pImgs[0].name}" data-imgs='${JSON.stringify(pImgs).replace(/'/g,"&#39;")}'><div class="carousel-controls"><button class="carousel-btn ctrl-play" onclick="togglePlay('${key}')" id="play-${key}" title="æš«åœ/æ’­æ”¾">âšâš</button><button class="carousel-btn ctrl-next" onclick="moveSlide('${key}',1)" title="ä¸‹ä¸€å¼µ">></button></div>`;
      carouselTimers[key] = setInterval(()=>moveSlide(key,1), 3000);
    }
    // ä¿®æ­£ï¼šopenDetail ä½¿ç”¨ global index
    return `<div class="honor-card"><div class="honor-media">${media}</div><div class="honor-content"><h3>${item.title}</h3><p>${item.date} | ${item.authorTitle}</p><button class="btn" onclick="openDetail(${allPosts.indexOf(item)})" title="æŸ¥çœ‹è©³æƒ…">è©³æƒ…</button></div></div>`;
  }).join('');

  // æ¦®è­½æ¦œåˆ†é 
  const total = Math.ceil(honorData.length/HONOR_PER_PAGE);
  const pag = document.getElementById('honor-pagination');
  if(pag) pag.innerHTML = total>1 ? Array.from({length:total},(_,i)=>`<button class="page-btn ${i+1===currentHonorPage?'active':''}" onclick="currentHonorPage=${i+1};renderHonorRollPage()" title="ç¬¬${i+1}é ">${i+1}</button>`).join('') : '';
}

function moveSlide(key, dir) {
  const img = document.getElementById(`img-${key}`);
  if(!img) return;
  const data = JSON.parse(img.dataset.imgs);
  let idx = (parseInt(img.dataset.idx) + dir + data.length) % data.length;
  img.src = data[idx].url; img.alt = data[idx].name; img.dataset.idx = idx;
}

function togglePlay(key) {
  const btn = document.getElementById(`play-${key}`);
  if(carouselTimers[key]) { clearInterval(carouselTimers[key]); delete carouselTimers[key]; btn.textContent='â–¶'; }
  else { carouselTimers[key] = setInterval(()=>moveSlide(key,1),3000); btn.textContent='âšâš'; }
}

// ========== å…¬å‘Šåˆ—è¡¨é‚è¼¯ ==========
function applyFilter() {
  const el = document.getElementById('cat-filter');
  if(!el) return;
  const cat = el.value;
  currentFilteredData = cat==='all' ? allPosts : allPosts.filter(p=>p.category===cat);
  currentPage = 1; renderCurrentPage();
}

function renderCurrentPage() {
  const list = document.getElementById('post-list');
  if(!list) return;
  const start = (currentPage-1)*ITEMS_PER_PAGE;
  list.innerHTML = currentFilteredData.slice(start, start+ITEMS_PER_PAGE).map(p => 
    `<div class="post-list-item" onclick="openDetail(${allPosts.indexOf(p)})">
       ${p.isPinned?'<span class="badge-pin">ç½®é ‚</span>':''} <b>${p.date}</b> ${p.title} 
       <span style="float:right;color:#888;">${p.category}</span>
     </div>`
  ).join('') || '<p style="padding:1.25rem;">ç„¡è³‡æ–™</p>';
  
  const total = Math.ceil(currentFilteredData.length/ITEMS_PER_PAGE);
  const pag = document.getElementById('pagination');
  if(pag) pag.innerHTML = total>1 ? Array.from({length:total},(_,i)=>`<button class="page-btn ${i+1===currentPage?'active':''}" onclick="currentPage=${i+1};renderCurrentPage()" title="ç¬¬${i+1}é ">${i+1}</button>`).join('') : '';
}

function openDetail(idx) {
  const d = allPosts[idx];
  if(!d) return;
  let attachHtml = '';
  if (d.attachments && d.attachments.length > 0) {
    attachHtml = `<div style="margin-top:1.25rem; padding:0.6rem; background:#f9f9f9; border:1px dashed #ccc;"><strong>é™„ä»¶ï¼š</strong><br>` + 
      d.attachments.map(f => `<a href="${getDriveImgUrl(f.url)}" target="_blank" style="margin-right:0.6rem;">ğŸ“ ${f.name}</a>`).join('') + `</div>`;
  }
  const modal = document.getElementById('modal-content');
  if(modal) {
    modal.innerHTML = `<h2>${d.title}</h2><p style="color:#666;">${d.date} | ${d.authorTitle}</p><div style="font-size:1.1rem; line-height:1.8;">${d.content.replace(/\n/g,'<br>')}</div>${attachHtml}`;
    document.getElementById('detail-modal').showModal();
  }
}
function closeDetail() { document.getElementById('detail-modal').close(); }

// ========== å¾Œå° & ç™»å…¥é‚è¼¯ ==========
function showLogin() { switchView('view-login'); }

function handleLogin(e) {
  e.preventDefault();
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  postData('login', {username:u, password:p}).then(res => {
    currentUser = res.username;
    const disp = document.getElementById('admin-user-display');
    if(disp) disp.textContent = res.jobTitle || res.username;
    
    // éš±è—å‰å°ç™»å…¥éˆ•
    const btnToggle = document.getElementById('btn-login-toggle');
    if(btnToggle) btnToggle.style.display='none';

    // å¦‚æœæ˜¯ç¸½ç®¡ï¼Œè¼‰å…¥é¡å¤–è³‡æ–™
    if(res.isSuper) {
      loadUsers(); 
      loadAdminSettings(); 
      loadAuthorSelect();
    }
    loadAdminPosts();
    switchView('view-admin');
  });
}

function switchView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
  const target = document.getElementById(id);
  if(target) target.classList.add('active-view');
  
  window.scrollTo(0,0);
  
  const container = document.getElementById('site-container');
  const navLinks = document.querySelectorAll('#site-nav a');
  navLinks.forEach(a => a.classList.remove('active'));

  if (id.startsWith('view-')) {
    const idx = ['view-home','view-about','view-admin-unit','view-resources','view-contact'].indexOf(id);
    if(idx>=0 && navLinks[idx]) navLinks[idx].classList.add('active');
  }

  if (id === 'view-admin' || id === 'view-cats' || id === 'view-users') {
    if(container) container.classList.add('admin-mode');
  } else {
    if(container) container.classList.remove('admin-mode');
  }
}

function switchAdminTab(tabId) {
  document.querySelectorAll('.admin-tab').forEach(t => t.style.display='none');
  const tab = document.getElementById(tabId); if(tab) tab.style.display='block';
}

function goHome() { switchView('view-home'); }
function logout() { location.reload(); }

// --- å¾Œå°åŠŸèƒ½ ---
function loadAdminPosts() {
  postData('getAdminData', {}).then(data => {
    window.adminData = data;
    renderAdminPosts();
  });
}

function renderAdminPosts() {
  const list = document.getElementById('admin-post-list');
  if(!list) return;
  const start = (currentAdminPage-1)*ADMIN_PER_PAGE;
  list.innerHTML = window.adminData.slice(start, start+ADMIN_PER_PAGE).map(p => 
    `<tr>
      <td style="border:1px solid #ddd;padding:0.5rem;">${p.date}</td>
      <td style="border:1px solid #ddd;padding:0.5rem;">${p.title}</td>
      <td style="border:1px solid #ddd;padding:0.5rem;">${p.category}</td>
      <td style="border:1px solid #ddd;padding:0.5rem;">${p.authorTitle}</td>
      <td style="border:1px solid #ddd;padding:0.5rem;">
        ${p.isMine ? `<button onclick='editPost(${JSON.stringify(p)})' class="btn btn-sec" style="padding:0.1rem 0.3rem;" title="ä¿®æ”¹å…¬å‘Š">ä¿®</button> <button onclick="deleteItem('deleteAnnouncement','${p.id}')" class="btn btn-danger" style="padding:0.1rem 0.3rem;" title="åˆªé™¤å…¬å‘Š">åˆª</button>` : '-'}
      </td>
    </tr>`
  ).join('');
  
  const total = Math.ceil(window.adminData.length/ADMIN_PER_PAGE);
  const pag = document.getElementById('admin-pagination');
  if(pag) pag.innerHTML = total>1 ? Array.from({length:total},(_,i)=>`<button class="page-btn ${i+1===currentAdminPage?'active':''}" onclick="currentAdminPage=${i+1};renderAdminPosts()" title="ç¬¬${i+1}é ">${i+1}</button>`).join('') : '';
}

function loadAuthorSelect() {
  postData('getUsers', {u:currentUser}).then(users => {
    const sel = document.getElementById('p-author');
    if(sel) sel.innerHTML = '<option value="">(ä¿ç•™åŸç™¼å¸ƒè€…)</option>' + users.map(u=>`<option value="${u.username}">${u.username} (${u.jobTitle})</option>`).join('');
  });
}

async function handlePostSave(e) {
  e.preventDefault();
  const fileInput = document.getElementById('p-file');
  let filesData = [];
  if (fileInput.files.length > 0) filesData = await Promise.all(Array.from(fileInput.files).map(readFileAsBase64));
  
  const formObj = {
    id: document.getElementById('p-id').value,
    title: document.getElementById('p-title').value,
    category: document.getElementById('p-cat').value,
    newAuthor: document.getElementById('p-author').value,
    content: document.getElementById('p-content').value,
    isPinned: document.getElementById('p-top').checked.toString(),
    pinExpiry: document.getElementById('p-pin-exp').value,
    expiryDate: document.getElementById('p-exp').value,
    link: document.getElementById('p-link').value,
    deleteAttachment: document.getElementById('del-attach').checked.toString(),
    filesData: filesData
  };
  postData('saveAnnouncement', {formObj}).then(()=>{ alert('æˆåŠŸ'); resetPostForm(); loadPosts(); loadAdminPosts(); });
}

function editPost(p) {
  document.getElementById('p-id').value = p.id;
  document.getElementById('p-title').value = p.title;
  document.getElementById('p-cat').value = p.category;
  document.getElementById('p-content').value = p.content;
  document.getElementById('p-top').checked = p.isPinned;
  document.getElementById('p-pin-exp').value = p.pinExpiry;
  document.getElementById('p-exp').value = p.expiryDate;
  document.getElementById('p-link').value = p.link;
  
  const list = document.getElementById('exist-file-list');
  const area = document.getElementById('curr-attach');
  if(p.attachments && p.attachments.length>0) {
    if(area) area.style.display='block';
    if(list) list.innerHTML = p.attachments.map(f=>f.name).join(', ');
  } else if(area) area.style.display='none';
}
function resetPostForm() { document.getElementById('admin-form').reset(); document.getElementById('p-id').value=""; document.getElementById('curr-attach').style.display='none'; }

// --- ç¶²ç«™æ¶æ§‹ç®¡ç† ---
function handleNavSave(e) {
  e.preventDefault();
  const item = { id: document.getElementById('nav-id').value, title: document.getElementById('nav-title').value, link: document.getElementById('nav-link').value, order: document.getElementById('nav-order').value };
  postData('saveNavbar', {navItem:item}).then(()=>{ alert('æˆåŠŸ'); loadSiteData().then(renderAdminLists); });
}
function handleWidgetSave(e) {
  e.preventDefault();
  const type = document.getElementById('wid-type').value;
  let content = "";
  if(type==='links') {
    const lines = document.getElementById('wid-content-links').value.split('\n');
    content = lines.map(l=>{ const [tx,url]=l.split('|'); return {label:tx, url:url}; }).filter(x=>x.label&&x.url);
  } else content = document.getElementById('wid-content-html').value;
  const widget = { id: document.getElementById('wid-id').value, title: document.getElementById('wid-title').value, type: type, pos: document.getElementById('wid-pos').value, order: document.getElementById('wid-order').value, content: content };
  postData('saveSidebar', {widget}).then(()=>{ alert('æˆåŠŸ'); loadSiteData().then(renderAdminLists); });
}
function toggleWidInput() {
  const t = document.getElementById('wid-type').value;
  document.getElementById('wid-input-links').style.display = t==='links'?'block':'none';
  document.getElementById('wid-input-html').style.display = t==='html'?'block':'none';
}
function renderAdminLists() {
  const navL = document.getElementById('admin-nav-list'); if(navL) navL.innerHTML = (siteData.navbar||[]).map(n=>`<li>${n.title} (æ’åº:${n.order}) <button onclick="deleteItem('deleteNavbar','${n.id}')" class="btn-danger" style="font-size:0.8rem;padding:0.1rem 0.3rem;" title="åˆªé™¤é¸å–®">åˆª</button></li>`).join('');
  const widL = document.getElementById('admin-wid-list'); if(widL) widL.innerHTML = (siteData.sidebar||[]).map(w=>`<li>[${w.pos}] ${w.title} <button onclick="deleteItem('deleteSidebar','${w.id}')" class="btn-danger" style="font-size:0.8rem;padding:0.1rem 0.3rem;" title="åˆªé™¤å€å¡Š">åˆª</button></li>`).join('');
}

// --- ä½¿ç”¨è€…èˆ‡è¨­å®š ---
function loadAdminSettings() {
  const nzh = document.getElementById('set-name-zh'); if(nzh) nzh.value = siteData.settings.schoolNameZH || "";
  const nen = document.getElementById('set-name-en'); if(nen) nen.value = siteData.settings.schoolNameEN || "";
  const col = document.getElementById('set-color'); if(col) col.value = siteData.settings.themeColor || "#00695c";
  const mod = document.getElementById('set-layout-mode'); if(mod) mod.value = siteData.settings.layoutMode || "wide";
  renderAdminLists();
}
function saveSiteSettings() {
  const s = { 
    schoolNameZH: document.getElementById('set-name-zh').value, 
    schoolNameEN: document.getElementById('set-name-en').value, 
    themeColor: document.getElementById('set-color').value,
    layoutMode: document.getElementById('set-layout-mode').value
  };
  postData('saveSettings', {settings:s}).then(()=>{ alert('è¨­å®šæ›´æ–°'); loadSiteData(); });
}

function loadUsers() {
  const permBox = document.getElementById('permission-checkboxes');
  if(permBox) permBox.innerHTML = (siteData.categories||[]).map(c=>`<label><input type="checkbox" name="user-permissions" value="${c.name}" title="æˆæ¬Š ${c.name}"> ${c.name}</label>`).join('');
  postData('getUsers', {}).then(users => {
    const tb = document.getElementById('user-tbody');
    if(tb) tb.innerHTML = users.map(u=>`<tr><td style="border:1px solid #ddd;padding:0.5rem;">${u.username}</td><td style="border:1px solid #ddd;padding:0.5rem;">${u.jobTitle}</td><td style="border:1px solid #ddd;padding:0.5rem;"><button onclick='editUser(${JSON.stringify(u)})' class="btn btn-sec" style="padding:0.1rem 0.3rem;" title="ä¿®æ”¹ä½¿ç”¨è€…">ä¿®</button> <button onclick="deleteItem('deleteUser','${u.username}')" class="btn btn-danger" style="padding:0.1rem 0.3rem;" title="åˆªé™¤ä½¿ç”¨è€…">åˆª</button></td></tr>`).join('');
  });
}
function handleUserSave(e) {
  e.preventDefault();
  let group = []; if(document.getElementById('role-super').checked) group.push('ç³»çµ±ç®¡ç†å“¡');
  document.querySelectorAll('input[name="user-permissions"]:checked').forEach(c=>group.push(c.value));
  const form = { isEdit: document.getElementById('user-is-edit').value==='true', username: document.getElementById('new-username').value, password: document.getElementById('new-password').value, jobTitle: document.getElementById('new-jobtitle').value, group: group.join(',') };
  if(!form.isEdit && (form.password.length<8 || form.password.length>20)) { alert("å¯†ç¢¼éœ€8-20å­—å…ƒ"); return; }
  if(form.isEdit && form.password && (form.password.length<8 || form.password.length>20)) { alert("å¯†ç¢¼éœ€8-20å­—å…ƒ"); return; }
  postData('saveUser', {formObj:form}).then(()=>{ alert('æˆåŠŸ'); resetUserForm(); loadUsers(); });
}
function editUser(u) {
  document.getElementById('user-form-title').textContent="ä¿®æ”¹"; document.getElementById('user-is-edit').value="true";
  document.getElementById('new-username').value=u.username; document.getElementById('new-username').readOnly=true;
  document.getElementById('new-jobtitle').value=u.jobTitle;
  const grps = u.group.split(',');
  document.getElementById('role-super').checked = grps.includes('ç³»çµ±ç®¡ç†å“¡');
  document.querySelectorAll('input[name="user-permissions"]').forEach(c=>c.checked=grps.includes(c.value));
}
function resetUserForm() { document.getElementById('user-form').reset(); document.getElementById('user-form-title').textContent="æ–°å¢"; document.getElementById('user-is-edit').value="false"; document.getElementById('new-username').readOnly=false; }
function toggleAllPerms(src) { document.querySelectorAll('input[name="user-permissions"]').forEach(c=>c.checked=src.checked); }

// åˆ†é¡ç®¡ç†
function handleCatSave(e) { e.preventDefault(); const id=document.getElementById('cat-id').value; const name=document.getElementById('cat-name').value; postData('saveCategory', {id,name}).then(()=>{ alert('æˆåŠŸ'); document.getElementById('cat-form').reset(); loadSiteData(); }); }
function editCat(id, name) { document.getElementById('cat-id').value=id; document.getElementById('cat-name').value=name; }
function toggleCat(id, active) { if(confirm("ç¢ºå®šåˆ‡æ›?")) postData('toggleCategoryStatus', {id, isActive:active}).then(()=>{ loadSiteData(); }); }

// å…±ç”¨å·¥å…·
async function postData(op, data) {
  data.currentUser = currentUser;
  const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ op, ...data }) });
  const json = await res.json();
  if (json.error) { alert(json.error); throw new Error(json.error); }
  return json;
}
function deleteItem(op, id) { if(confirm("ç¢ºå®šåˆªé™¤?")) postData(op, {id}).then(() => { if(op.includes('Navbar')||op.includes('Sidebar')) loadSiteData().then(renderAdminLists); else if(op.includes('User')) loadUsers(); else if(op.includes('Category')) loadSiteData(); else { loadPosts(); loadAdminPosts(); } }); }
function openChangePasswordModal() { document.getElementById('password-modal').showModal(); }
function handleChangePassword(e) {
  e.preventDefault();
  const o=document.getElementById('cp-old').value, n=document.getElementById('cp-new').value, c=document.getElementById('cp-confirm').value;
  if(n!==c){alert("å¯†ç¢¼ä¸ç¬¦");return;}
  if(n.length<8||n.length>20){alert("å¯†ç¢¼é•·åº¦éœ€8-20å­—å…ƒ");return;}
  postData('changePassword', {username:currentUser, oldPassword:o, newPassword:n}).then(()=>{ alert("ä¿®æ”¹æˆåŠŸ"); document.getElementById('password-modal').close(); });
}
function showMessage(msg) { const el = document.getElementById('global-status'); if(el){ el.textContent = msg; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); }}
function readFileAsBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res({ name: file.name, mimeType: file.type, data: r.result }); r.onerror = rej; r.readAsDataURL(file); }); }
</script>
</body>
</html>