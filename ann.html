<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç„¡éšœç¤™å…¬å‘Šç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ========== AAA ç´šåŸºç¤è¨­å®š ========== */
    :root { --bg: #ffffff; --text: #000000; --focus: #FFD700; --border: #000000; --input-bg: #f5f5f5; --card-bg: #f9f9f9; }
    @media (prefers-color-scheme: dark) { :root { --bg: #222222; --text: #ffffff; --focus: #FFD700; --border: #555555; --input-bg: #333333; --card-bg: #333333; } }
    
    html, body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); font-size: 100%; line-height: 1.6; margin: 0; padding: 0; }
    body { padding: 1.5rem; max-width: 60rem; margin: 0 auto; }
    *:focus { outline: 0.25rem solid var(--focus) !important; outline-offset: 0.125rem; }
    
    .btn { padding: 0.5rem 1rem; background: var(--text); color: var(--bg); border: 1px solid transparent; cursor: pointer; font-weight: bold; border-radius: 4px; display: inline-block; text-decoration: none; }
    .btn:hover { opacity: 0.9; }
    .btn-danger { background: #cc0000; color: #fff; }
    .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    
    /* å½ˆå‡ºè¦–çª— Dialog */
    dialog {
      background: var(--bg); color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      max-width: 800px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    dialog::backdrop { background: rgba(0, 0, 0, 0.7); }
    
    /* å…¬å‘Šåˆ—è¡¨ (å¡ç‰‡å¼) */
    .post-list-item {
      padding: 1.2rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .post-list-item:hover { background: var(--input-bg); }
    .post-list-item h2 { margin: 0 0 0.5rem 0; font-size: 1.3rem; color: var(--text); text-decoration: underline; text-underline-offset: 4px; }
    .post-meta { font-size: 0.95rem; opacity: 0.9; }
    .badge-pin { background: #b00; color: #fff; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; margin-right: 5px; font-weight: bold; }

    /* å…¶ä»– CSS */
    .view { display: none; } .active-view { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .status-msg { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--bg); padding: 1rem 2rem; border: 2px solid var(--focus); z-index: 2000; display: none; }
    input, select, textarea { width: 100%; padding: 8px; margin-bottom: 15px; background: var(--input-bg); color: var(--text); border: 1px solid var(--border); box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: left; }
    
    /* åˆ†é¡ç‹€æ…‹ */
    .status-on { background: #d4edda; color: #155724; padding: 2px 5px; border-radius: 3px; font-size:0.85rem; }
    .status-off { background: #f8d7da; color: #721c24; padding: 2px 5px; border-radius: 3px; font-size:0.85rem; }
    .cat-disabled { text-decoration: line-through; color: #888; }
  </style>
</head>
<body>

  <div id="global-status" role="alert" class="status-msg"></div>

  <div id="view-public" class="view active-view">
    <header style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--border); padding-bottom:10px; margin-bottom:20px;">
      <h1 style="margin:0;">æœ€æ–°å…¬å‘Šç³»çµ±</h1>
      <button onclick="switchView('view-login')" class="btn">ç®¡ç†å“¡ç™»å…¥</button>
    </header>

    <div style="margin-bottom:20px;">
      <label for="category-filter">åˆ†é¡ç¯©é¸ï¼š</label>
      <select id="category-filter" onchange="applyFilter()"><option value="all">è¼‰å…¥ä¸­...</option></select>
    </div>

    <div id="public-list" style="border-top: 1px solid var(--border);">
      <p>è³‡æ–™è¼‰å…¥ä¸­...</p>
    </div>
  </div>

  <dialog id="detail-modal">
    <div style="text-align:right;"><button onclick="closeDetail()" class="btn btn-secondary">é—œé–‰ âœ•</button></div>
    <div id="modal-content"></div>
  </dialog>

  <div id="view-login" class="view">
    <h1>ç®¡ç†å“¡ç™»å…¥</h1>
    <form onsubmit="handleLogin(event)" style="max-width:400px; margin:auto; border:1px solid var(--border); padding:20px;">
      <label>å¸³è™Ÿ</label><input type="text" id="username" required>
      <label>å¯†ç¢¼</label><input type="password" id="password" required>
      <button type="submit" class="btn">ç™»å…¥</button>
      <button type="button" class="btn btn-secondary" onclick="switchView('view-public')">å–æ¶ˆ</button>
    </form>
  </div>

  <div id="view-admin" class="view">
    <header style="display:flex; justify-content:space-between; border-bottom:2px solid var(--border); padding-bottom:10px; margin-bottom:20px;">
      <h1 style="margin:0;">å¾Œå°ç®¡ç† - <span id="user-display" style="font-size:1rem;"></span></h1>
      <div>
        <button onclick="switchView('view-public')" class="btn btn-secondary">å‰å°</button>
        <button id="btn-cats" onclick="switchView('view-cats')" class="btn btn-secondary" style="display:none;">åˆ†é¡</button>
        <button id="btn-users" onclick="switchView('view-users')" class="btn btn-secondary" style="display:none;">ä½¿ç”¨è€…</button>
        <button onclick="logout()" class="btn">ç™»å‡º</button>
      </div>
    </header>

    <div style="background:var(--input-bg); padding:20px; border:1px solid var(--border); margin-bottom:30px;">
      <h2 style="margin-top:0;">ç™¼å¸ƒ/ç·¨è¼¯å…¬å‘Š</h2>
      <form id="admin-form" onsubmit="handleSave(event)">
        <input type="hidden" id="post-id">
        <label>æ¨™é¡Œ</label><input type="text" id="post-title" required>
        <label>åˆ†é¡</label><select id="post-cat" required><option>è¼‰å…¥ä¸­...</option></select>
        <label>å…§å®¹</label><textarea id="post-content" rows="6" required></textarea>
        
        <div style="border:1px dashed var(--border); padding:10px; margin-bottom:15px;">
          <label>é™„ä»¶ä¸Šå‚³</label><input type="file" id="post-file">
          <div id="current-attachment-info" style="display:none; margin-top:5px;">
            <a href="#" target="_blank" id="existing-file-link">æŸ¥çœ‹ç¾æœ‰é™„ä»¶</a>
            <label style="display:inline-block; margin-left:10px;"><input type="checkbox" id="delete-attachment" style="width:auto;"> åˆªé™¤èˆŠæª”</label>
          </div>
        </div>

        <div style="margin-bottom:15px;">
          <label style="display:inline-block;"><input type="checkbox" id="post-pinned" style="width:auto;"> è¨­ç‚ºç½®é ‚</label>
          <label style="margin-left:20px;">ç½®é ‚æœŸé™ï¼š<input type="date" id="post-pin-expiry" style="width:auto; display:inline-block;"></label>
        </div>
        
        <label>ä¸‹æ¶æ—¥æœŸ</label><input type="date" id="post-expiry">
        <label>å¤–éƒ¨é€£çµ</label><input type="url" id="post-link">
        
        <button type="submit" class="btn">å„²å­˜å…¬å‘Š</button>
        <button type="button" onclick="resetForm()" class="btn btn-secondary">æ¸…ç©º</button>
      </form>
    </div>

    <table>
      <thead><tr><th>æ—¥æœŸ</th><th>æ¨™é¡Œ</th><th>åˆ†é¡</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="admin-tbody"></tbody>
    </table>
  </div>

  <div id="view-cats" class="view">
    <header><h1>åˆ†é¡ç®¡ç†</h1><button onclick="switchView('view-admin')" class="btn btn-secondary">è¿”å›</button></header>
    <div style="background:var(--input-bg); padding:20px; border:1px solid var(--border); margin:20px 0;">
      <form id="cat-form" onsubmit="handleCatSave(event)" style="display:flex; gap:10px; align-items:flex-end;">
        <input type="hidden" id="cat-id">
        <div style="flex-grow:1;"><label>åˆ†é¡åç¨±</label><input type="text" id="cat-name" required style="margin:0;"></div>
        <button type="submit" class="btn">å„²å­˜</button>
      </form>
    </div>
    <table><thead><tr><th>åç¨±</th><th>æ“ä½œ</th></tr></thead><tbody id="cat-tbody"></tbody></table>
  </div>

  <div id="view-users" class="view">
    <header><h1>ä½¿ç”¨è€…ç®¡ç†</h1><button onclick="switchView('view-admin')" class="btn btn-secondary">è¿”å›</button></header>
    <div style="background:var(--input-bg); padding:20px; border:1px solid var(--border); margin:20px 0;">
      <h2 style="margin-top:0;" id="user-form-title">æ–°å¢ä½¿ç”¨è€…</h2>
      <form id="user-form" onsubmit="handleUserSave(event)">
        <input type="hidden" id="user-is-edit" value="false">
        <label>å¸³è™Ÿ</label><input type="text" id="new-username" required>
        <label>è·ç¨±</label><input type="text" id="new-jobtitle" required>
        <label>å¯†ç¢¼</label><input type="password" id="new-password">
        <div style="border:1px solid var(--border); padding:10px;">
          <p style="margin:0 0 10px 0;"><strong>æ¬Šé™è¨­å®šï¼š</strong></p>
          <label><input type="checkbox" id="role-super" style="width:auto;"> ç³»çµ±ç®¡ç†å“¡</label>
          <div id="permission-checkboxes" style="margin-top:10px;"></div>
        </div>
        <button type="submit" class="btn" style="margin-top:15px;">å„²å­˜ä½¿ç”¨è€…</button>
        <button type="button" class="btn btn-secondary" style="margin-top:15px;" onclick="resetUserForm()">é‡ç½®</button>
      </form>
    </div>
    <table><thead><tr><th>å¸³è™Ÿ</th><th>è·ç¨±</th><th>æ¬Šé™</th><th>æ“ä½œ</th></tr></thead><tbody id="user-tbody"></tbody></table>
  </div>

  <script>
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS ç¶²å€ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbzxoLJzyCdEJ8by36gYS8XOZ81dbpTZL3CiVYmOiaSeA_Ho-dpNAXvMzKZcFzpJVvTF/exec";

    let currentUser = null, allPublicData = [], categories = [];

    document.addEventListener('DOMContentLoaded', () => { loadCategories(); loadPublicData(); });

    async function callApi(op, data = {}) {
      try {
        const url = ['getPublicData', 'getCategories'].includes(op) ? `${API_URL}?op=${op}` : API_URL;
        const opts = ['getPublicData', 'getCategories'].includes(op) ? {} : { method: 'POST', body: JSON.stringify({ op, ...data }) };
        const res = await fetch(url, opts);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        return json;
      } catch (e) { throw new Error("API éŒ¯èª¤ï¼š" + e.message); }
    }

    function showMessage(msg) { const el = document.getElementById('global-status'); el.textContent = msg; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); }
    function readFileAsBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res({ name: file.name, mimeType: file.type, data: r.result }); r.onerror = rej; r.readAsDataURL(file); }); }

    function switchView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
      document.getElementById(id).classList.add('active-view');
      if (id === 'view-public') {
        document.getElementById('category-filter').value = 'all';
        loadPublicData();
      }
      if (id === 'view-users') loadUsers();
    }

    // --- å…¬é–‹è³‡æ–™ & å½ˆå‡ºè¦–çª— ---
    function loadCategories() { callApi('getCategories').then(d => { categories = d; renderCategorySelects(); renderCategoryTable(); }); }
    function loadPublicData() { callApi('getPublicData').then(d => { allPublicData = d; renderPublic(d); }).catch(e => document.getElementById('public-list').innerHTML='è¼‰å…¥å¤±æ•—'); }
    
    function renderCategorySelects() {
      const active = categories.filter(c => c.isActive);
      const html = active.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
      document.getElementById('category-filter').innerHTML = `<option value="all">æ‰€æœ‰åˆ†é¡</option>` + html;
      document.getElementById('post-cat').innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡...</option>` + html;
    }

    function renderPublic(data) {
      const list = document.getElementById('public-list');
      if (data.length === 0) { list.innerHTML = '<p style="padding:20px;">ç„¡å…¬å‘Š</p>'; return; }
      list.innerHTML = data.map((item, idx) => {
        const pinHtml = item.isPinned ? `<span class="badge-pin">ğŸ“Œ ç½®é ‚</span>` : '';
        // é»æ“Šäº‹ä»¶ç¶å®š index
        return `
          <div class="post-list-item" onclick="openDetail(${idx})" role="button" tabindex="0">
            ${pinHtml}
            <h2>${item.title}</h2>
            <div class="post-meta">
              <strong>${item.date}</strong> | ${item.category} | ç™¼å¸ƒè€…ï¼š${item.authorTitle}
            </div>
          </div>`;
      }).join('');
    }

    function openDetail(idx) {
      const item = allPublicData[idx];
      const modal = document.getElementById('detail-modal');
      const contentDiv = document.getElementById('modal-content');
      
      const pinHtml = item.isPinned ? `<span class="badge-pin">ğŸ“Œ ç½®é ‚å…¬å‘Š</span>` : '';
      const attachHtml = item.attachment ? `<div style="margin-top:20px; padding:10px; border:1px dashed #ccc;"><a href="${item.attachment}" target="_blank" class="btn">ğŸ“ ä¸‹è¼‰é™„ä»¶</a></div>` : '';
      const linkHtml = item.link ? `<div style="margin-top:10px;"><a href="${item.link}" target="_blank" class="btn">ğŸ”— å‰å¾€å¤–éƒ¨é€£çµ</a></div>` : '';

      contentDiv.innerHTML = `
        <h1 style="margin-top:0;">${pinHtml} ${item.title}</h1>
        <p style="border-bottom:1px solid #ccc; padding-bottom:10px;">
          <strong>${item.date}</strong> | åˆ†é¡ï¼š${item.category} | ç™¼å¸ƒè€…ï¼š${item.authorTitle}
        </p>
        <div style="font-size:1.1rem; line-height:1.8;">
          ${item.content.replace(/\n/g, '<br>')}
        </div>
        ${attachHtml} ${linkHtml}
      `;
      modal.showModal();
    }

    function closeDetail() { document.getElementById('detail-modal').close(); }
    function applyFilter() {
      const cat = document.getElementById('category-filter').value;
      const filtered = cat === 'all' ? allPublicData : allPublicData.filter(d => d.category === cat);
      renderPublic(filtered);
    }

    // --- ç™»å…¥ ---
    function handleLogin(e) {
      e.preventDefault(); showMessage("ç™»å…¥ä¸­...");
      callApi('login', { username: document.getElementById('username').value, password: document.getElementById('password').value }).then(res => {
        currentUser = res.username;
        document.getElementById('user-display').textContent = res.jobTitle || res.username;
        const isSuper = res.isSuperAdmin;
        document.getElementById('btn-cats').style.display = isSuper ? 'inline-block' : 'none';
        document.getElementById('btn-users').style.display = isSuper ? 'inline-block' : 'none';
        loadAdminData(); switchView('view-admin'); document.getElementById('username').value=''; document.getElementById('password').value='';
      }).catch(e => showMessage(e.message));
    }
    function logout() { currentUser = null; switchView('view-public'); showMessage("å·²ç™»å‡º"); }

    // --- å¾Œå°å…¬å‘Š ---
    function loadAdminData() {
      callApi('getAdminData', { currentUser }).then(d => {
        document.getElementById('admin-tbody').innerHTML = d.map(i => `
          <tr style="${i.author === currentUser ? 'background:rgba(255,215,0,0.1);' : ''}">
            <td>${i.date}</td><td>${i.title}</td><td>${i.category}</td>
            <td>${i.isMine ? `<button onclick='editPost(${JSON.stringify(i)})' class="btn">ä¿®</button> <button onclick='deletePost("${i.id}")' class="btn btn-danger">åˆª</button>` : '-'}</td>
          </tr>`).join('');
      });
    }
    async function handleSave(e) {
      e.preventDefault(); showMessage("å„²å­˜ä¸­...");
      try {
        const fileInput = document.getElementById('post-file');
        let fileData = null;
        if (fileInput.files.length > 0) fileData = await readFileAsBase64(fileInput.files[0]);
        const formData = {
          id: document.getElementById('post-id').value,
          title: document.getElementById('post-title').value,
          content: document.getElementById('post-content').value,
          category: document.getElementById('post-cat').value,
          link: document.getElementById('post-link').value,
          expiryDate: document.getElementById('post-expiry').value,
          isPinned: document.getElementById('post-pinned').checked.toString(),
          pinExpiry: document.getElementById('post-pin-expiry').value,
          deleteAttachment: document.getElementById('delete-attachment').checked.toString(),
          fileData: fileData
        };
        await callApi('saveAnnouncement', { formObj: formData, currentUser });
        showMessage("æˆåŠŸ"); resetForm(); loadAdminData();
      } catch (e) { showMessage("å¤±æ•—: " + e.message); }
    }
    function editPost(item) {
      document.getElementById('post-id').value = item.id;
      document.getElementById('post-title').value = item.title;
      document.getElementById('post-content').value = item.content;
      document.getElementById('post-cat').value = item.category;
      document.getElementById('post-link').value = item.link;
      document.getElementById('post-expiry').value = item.expiryDate;
      document.getElementById('post-pinned').checked = item.isPinned;
      document.getElementById('post-pin-expiry').value = item.pinExpiry;
      const info = document.getElementById('current-attachment-info');
      const link = document.getElementById('existing-file-link');
      if(item.attachment) { info.style.display='block'; link.href=item.attachment; } else { info.style.display='none'; }
      document.getElementById('post-file').value = "";
      document.getElementById('delete-attachment').checked = false;
      document.getElementById('post-title').focus();
    }
    function deletePost(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) callApi('deleteAnnouncement', {id, currentUser}).then(()=>{ showMessage("å·²åˆªé™¤"); loadAdminData(); }); }
    function resetForm() { document.getElementById('admin-form').reset(); document.getElementById('post-id').value=""; document.getElementById('current-attachment-info').style.display='none'; }

    // --- åˆ†é¡ç®¡ç† ---
    function handleCatSave(e) {
      e.preventDefault();
      callApi('saveCategory', { id: document.getElementById('cat-id').value, name: document.getElementById('cat-name').value, currentUser }).then(()=>{
        showMessage("æˆåŠŸ"); document.getElementById('cat-form').reset(); document.getElementById('cat-id').value=""; loadCategories();
      });
    }
    function editCat(id, name) { document.getElementById('cat-id').value = id; document.getElementById('cat-name').value = name; document.getElementById('cat-name').focus(); }
    function toggleCat(id, isActive) { if(confirm(`ç¢ºå®š${isActive?'å•Ÿç”¨':'åœç”¨'}ï¼Ÿ`)) callApi('toggleCategoryStatus', {id, isActive, currentUser}).then(()=>{ showMessage("æ›´æ–°æˆåŠŸ"); loadCategories(); }); }
    function deleteCat(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿå»ºè­°ä½¿ç”¨åœç”¨ã€‚")) callApi('deleteCategory', {id, currentUser}).then(()=>{ showMessage("å·²åˆªé™¤"); loadCategories(); }); }
    function renderCategoryTable() {
      document.getElementById('cat-tbody').innerHTML = categories.map(c => `
        <tr>
          <td><span class="${c.isActive?'':'cat-disabled'}">${c.name}</span> ${c.isActive?'<span class="status-on">å•Ÿç”¨</span>':'<span class="status-off">åœç”¨</span>'}</td>
          <td>
            <button onclick="editCat('${c.id}','${c.name}')" class="btn">ä¿®</button>
            <button onclick="toggleCat('${c.id}',${!c.isActive})" class="btn ${c.isActive?'btn-danger':'btn'}">${c.isActive?'åœç”¨':'å•Ÿç”¨'}</button>
            <button onclick="deleteCat('${c.id}')" class="btn btn-secondary">åˆª</button>
          </td>
        </tr>`).join('');
    }

    // --- ä½¿ç”¨è€…ç®¡ç† ---
    function loadUsers() {
      const container = document.getElementById('permission-checkboxes');
      container.innerHTML = categories.map(c => `<label style="display:inline-block; margin-right:15px;"><input type="checkbox" name="user-permissions" value="${c.name}" style="width:auto;"> ${c.name}</label>`).join('');
      callApi('getUsers', { currentUser }).then(users => {
        document.getElementById('user-tbody').innerHTML = users.map(u => `<tr><td>${u.username}</td><td>${u.jobTitle}</td><td>${u.group}</td><td>${u.username===currentUser?'(è‡ªå·±)':`<button onclick='editUser(${JSON.stringify(u)})' class="btn">ä¿®</button> <button onclick="deleteUser('${u.username}')" class="btn btn-danger">åˆª</button>`}</td></tr>`).join('');
      });
    }
    function handleUserSave(e) {
      e.preventDefault();
      let selected = [];
      if(document.getElementById('role-super').checked) selected.push('ç³»çµ±ç®¡ç†å“¡');
      document.querySelectorAll('input[name="user-permissions"]:checked').forEach(cb => selected.push(cb.value));
      if(selected.length===0){ alert("è«‹é¸æ¬Šé™"); return; }
      const data = {
        isEdit: document.getElementById('user-is-edit').value === 'true',
        username: document.getElementById('new-username').value,
        password: document.getElementById('new-password').value,
        jobTitle: document.getElementById('new-jobtitle').value,
        group: selected.join(',')
      };
      callApi('saveUser', { formObj: data, currentUser }).then(()=>{ showMessage("æˆåŠŸ"); resetUserForm(); loadUsers(); });
    }
    function editUser(u) {
      document.getElementById('user-form-title').textContent = "ä¿®æ”¹ä½¿ç”¨è€…";
      document.getElementById('user-is-edit').value = "true";
      document.getElementById('new-username').value = u.username; document.getElementById('new-username').readOnly = true;
      document.getElementById('new-jobtitle').value = u.jobTitle;
      const grps = u.group.split(',');
      document.getElementById('role-super').checked = grps.includes('ç³»çµ±ç®¡ç†å“¡');
      document.querySelectorAll('input[name="user-permissions"]').forEach(cb => cb.checked = grps.includes(cb.value));
    }
    function resetUserForm() {
      document.getElementById('user-form').reset(); document.getElementById('user-form-title').textContent = "æ–°å¢ä½¿ç”¨è€…"; document.getElementById('user-is-edit').value = "false"; document.getElementById('new-username').readOnly = false;
    }
    function deleteUser(u) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) callApi('deleteUser', {targetUsername:u, currentUser}).then(()=>{ showMessage("å·²åˆªé™¤"); loadUsers(); }); }
  </script>
</body>
</html>
