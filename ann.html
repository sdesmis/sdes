<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç„¡éšœç¤™å…¬å‘Šç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="ç¬¦åˆç„¡éšœç¤™ AAA æ¨™æº–çš„å…¬å‘Šç™¼å¸ƒèˆ‡ç®¡ç†ç³»çµ±">
  <style>
    /* =========================================
       AAA ç´šç„¡éšœç¤™æ¨£å¼ (High Contrast & Responsive)
       ========================================= */
    :root { 
      --bg: #ffffff; 
      --text: #000000; 
      --focus: #FFD700; /* å¼·çƒˆå°æ¯”ç„¦é»è‰² */
      --border: #000000; 
      --input-bg: #f5f5f5;
      --btn-text: #ffffff;
    }
    
    /* æ·±è‰²æ¨¡å¼æ”¯æ´ */
    @media (prefers-color-scheme: dark) { 
      :root { 
        --bg: #000000; 
        --text: #ffffff; 
        --focus: #FFD700; 
        --border: #ffffff; 
        --input-bg: #333333;
        --btn-text: #000000;
      } 
    }
    
    /* åŸºç¤è¨­å®šï¼šä½¿ç”¨ç›¸å°å–®ä½ rem */
    html, body { 
      font-family: "Helvetica Neue", Arial, "Heiti TC", sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      font-size: 100%; 
      line-height: 1.8; /* AAA: å¯¬é¬†è¡Œé«˜ */
      letter-spacing: 0.12em; 
      word-spacing: 0.16em; 
      margin: 0; 
      padding: 0; 
    }

    /* ç¢ºä¿æ‰€æœ‰å…ƒç´ ç¹¼æ‰¿å­—é«”è¨­å®š */
    div, p, span, a, li, td, th, label, input, button, select, textarea { 
      font-size: 1rem; 
      line-height: inherit; 
      font-family: inherit;
    }

    body { 
      padding: 1.25rem; 
      max-width: 60rem; 
      margin: 0 auto; 
    }

    /* å¼·åˆ¶é¡¯ç¤ºç„¦é»ç‹€æ…‹ (AAA é—œéµ) */
    *:focus { 
      outline: 0.25rem solid var(--focus) !important; 
      outline-offset: 0.125rem; 
    }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { 
      padding: 0.75rem 1.25rem; 
      background: var(--text); 
      color: var(--bg); 
      border: 0.125rem solid transparent; 
      cursor: pointer; 
      font-weight: bold; 
      text-decoration: none; 
      display: inline-block; 
      margin-right: 0.5rem;
      border-radius: 0.25rem;
    }
    .btn:hover { text-decoration: underline; opacity: 0.9; }
    .btn-danger { background: #cc0000; color: #ffffff; }
    .btn-secondary { background: transparent; color: var(--text); border: 0.125rem solid var(--border); }
    
    /* è¡¨å–®å…ƒä»¶ */
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; font-weight: bold; margin-bottom: 0.5rem; font-size: 1.1rem; }
    input[type="text"], input[type="password"], input[type="date"], input[type="url"], select, textarea { 
      width: 100%; 
      padding: 0.75rem; 
      font-size: 1.1rem; 
      border: 0.125rem solid var(--border); 
      background: var(--input-bg); 
      color: var(--text); 
      box-sizing: border-box; 
      border-radius: 0.25rem; 
    }

    /* è¦–åœ–åˆ‡æ›æ©Ÿåˆ¶ */
    .view { display: none; }
    .active-view { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* è¼”åŠ©é–±è®€ (Screen Reader Only) */
    .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
    
    /* å…¨åŸŸè¨Šæ¯é€šçŸ¥ */
    .status-msg { 
      position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); 
      background: var(--text); color: var(--bg); 
      padding: 1rem 2rem; font-weight: bold; 
      border: 0.25rem solid var(--focus); z-index: 1000; 
      display: none; font-size: 1.2rem; 
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    /* è¡¨æ ¼æ¨£å¼ */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; border: 0.125rem solid var(--border); }
    th, td { border: 0.0625rem solid var(--border); padding: 0.75rem; text-align: left; vertical-align: top; }
    th { background: var(--text); color: var(--bg); font-weight: bold; }

    /* å…¬å‘Šå¡ç‰‡ */
    .announcement { border: 0.125rem solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.25rem; }
    .pinned-post { border: 0.3rem solid var(--text) !important; background-color: var(--input-bg); position: relative; }
    .pin-badge { background: var(--text); color: var(--bg); padding: 0.25rem 0.5rem; font-weight: bold; display: inline-block; margin-bottom: 0.75rem; }
    
    .attachment-link { 
      display: inline-block; margin-top: 1rem; 
      padding: 0.5rem 1rem; 
      border: 0.125rem dashed var(--border); 
      color: var(--text); text-decoration: none; font-weight: bold; 
    }
    .attachment-link:hover { background: var(--text); color: var(--bg); }

    /* æ¨™é¡Œå±¤ç´š */
    h1 { font-size: 2rem; margin: 1.5rem 0; line-height: 1.3; border-bottom: 0.125rem solid var(--border); padding-bottom: 0.5rem; }
    h2 { font-size: 1.5rem; margin: 1.2rem 0; line-height: 1.4; }
    h3 { font-size: 1.25rem; margin: 1rem 0; }

    /* æ ¸å–æ–¹å¡Šç¾¤çµ„ */
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem; }
    .checkbox-item { 
      display: flex; align-items: center; gap: 0.5rem; 
      background: var(--input-bg); padding: 0.5rem 1rem; 
      border: 0.0625rem solid var(--border); border-radius: 0.25rem; 
    }
    .checkbox-item input { width: 1.25rem; height: 1.25rem; cursor: pointer; }
  </style>
</head>
<body>

  <div id="global-status" role="alert" aria-live="assertive" class="status-msg"></div>
  
  <a href="#main-start" style="position:absolute; top:-5rem; left:0; padding:1rem; background:var(--focus); color:#000; z-index:100; font-size:1.2rem; font-weight:bold; text-decoration:none;" onfocus="this.style.top='0'">è·³è‡³ä¸»è¦å…§å®¹</a>

  <div id="view-public" class="view active-view" role="main">
    <header style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem;">
      <h1>æœ€æ–°å…¬å‘Šæ¶ˆæ¯</h1>
      <button onclick="switchView('view-login')" class="btn">ç®¡ç†å“¡ç™»å…¥</button>
    </header>

    <div id="main-start">
      <div class="form-group" style="background:var(--input-bg); padding:1.5rem; border:0.125rem solid var(--border); margin-top:1rem;">
        <label for="category-filter">ä¾å…¬å‘Šåˆ†é¡ç¯©é¸ï¼š</label>
        <select id="category-filter" onchange="applyFilter()" disabled>
          <option value="all">è¼‰å…¥ä¸­...</option>
        </select>
      </div>
      
      <div id="filter-status" class="visually-hidden" role="status" aria-live="polite"></div>
      
      <div id="public-list">
        <p style="font-size:1.2rem; padding:1rem;">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
      </div>
    </div>
  </div>

  <div id="view-login" class="view" role="main">
    <header>
      <h1 tabindex="-1" id="login-heading">ç®¡ç†å“¡ç™»å…¥</h1>
    </header>
    <form id="login-form" onsubmit="handleLogin(event)" style="max-width:30rem; margin:2rem auto; padding:2rem; border:0.125rem solid var(--border); border-radius:0.5rem;">
      <div class="form-group">
        <label for="username">å¸³è™Ÿ</label>
        <input type="text" id="username" required autocomplete="username">
      </div>
      <div class="form-group">
        <label for="password">å¯†ç¢¼</label>
        <input type="password" id="password" required autocomplete="current-password">
      </div>
      <div style="margin-top:2rem;">
        <button type="submit" class="btn">ç™»å…¥ç³»çµ±</button>
        <button type="button" class="btn btn-secondary" onclick="switchView('view-public')">å–æ¶ˆè¿”å›</button>
      </div>
    </form>
  </div>

  <div id="view-admin" class="view" role="main">
    <header>
      <h1 tabindex="-1">å¾Œå°ç®¡ç†</h1>
      <div style="margin-bottom:1rem; font-size:1.1rem;">
        ç™»å…¥èº«åˆ†ï¼š<span id="user-display" style="font-weight:bold; background:var(--input-bg); padding:0.2rem 0.5rem;"></span>
      </div>
      <nav role="navigation" aria-label="å¾Œå°é¸å–®" style="margin-bottom:1.5rem;">
        <button onclick="switchView('view-public')" class="btn btn-secondary">æª¢è¦–å‰å°</button>
        <button id="btn-manage-cats" onclick="switchView('view-cats')" class="btn btn-secondary" style="display:none;">ç®¡ç†åˆ†é¡</button>
        <button id="btn-manage-users" onclick="switchView('view-users')" class="btn btn-secondary" style="display:none;">ç®¡ç†ä½¿ç”¨è€…</button>
        <button onclick="logout()" class="btn">ç™»å‡º</button>
      </nav>
    </header>

    <section aria-labelledby="form-heading" style="background:var(--input-bg); padding:1.5rem; border:0.125rem solid var(--border); margin-bottom:2.5rem;">
      <h2 id="form-heading">ç™¼å¸ƒ/ç·¨è¼¯å…¬å‘Š</h2>
      <form id="admin-form" onsubmit="handleSave(event)">
        <input type="hidden" id="post-id"> <div class="form-group">
          <label for="post-title">æ¨™é¡Œ (å¿…å¡«)</label>
          <input type="text" id="post-title" required>
        </div>
        
        <div class="form-group">
          <label for="post-cat">åˆ†é¡ (å¿…å¡«)</label>
          <select id="post-cat" required>
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="post-content">å…§å®¹ (å¿…å¡«)</label>
          <textarea id="post-content" rows="6" required></textarea>
        </div>
        
        <div class="form-group" style="border: 0.125rem dashed var(--border); padding: 1rem; background:var(--bg);">
          <label for="post-file">ä¸Šå‚³é™„ä»¶ (é¸å¡«ï¼Œå–®ä¸€æª”æ¡ˆ)</label>
          <input type="file" id="post-file">
          
          <div id="current-attachment-info" style="margin-top:1rem; display:none;">
            <p><strong>ç›®å‰å·²æœ‰é™„ä»¶ï¼š</strong> <a href="#" target="_blank" id="existing-file-link">ä¸‹è¼‰/é è¦½æª”æ¡ˆ</a></p>
            <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
              <input type="checkbox" id="delete-attachment" style="width:1.5rem; height:1.5rem;">
              <label for="delete-attachment" style="margin:0; color:#b00;">åˆªé™¤èˆŠé™„ä»¶</label>
            </div>
          </div>
        </div>

        <fieldset style="border: 0.125rem solid var(--border); padding: 1rem; margin-bottom: 1.5rem; background:var(--bg);">
          <legend style="font-weight:bold; padding:0 0.5rem;">ç½®é ‚è¨­å®š</legend>
          <div class="form-group" style="display:flex; align-items:center; gap:0.8rem;">
            <input type="checkbox" id="post-pinned" style="width:1.5rem; height:1.5rem;">
            <label for="post-pinned" style="margin:0;">å°‡æ­¤å…¬å‘Šè¨­ç‚ºç½®é ‚</label>
          </div>
          <div class="form-group">
            <label for="post-pin-expiry">ç½®é ‚æœ‰æ•ˆæœŸé™ (é¸å¡«)</label>
            <input type="date" id="post-pin-expiry">
          </div>
        </fieldset>

        <div class="form-group">
          <label for="post-expiry">å…¬å‘Šä¸‹æ¶æ—¥æœŸ (é¸å¡«ï¼ŒéæœŸå¾Œå‰å°ä¸é¡¯ç¤º)</label>
          <input type="date" id="post-expiry">
        </div>

        <div class="form-group">
          <label for="post-link">å¤–éƒ¨é€£çµ URL (é¸å¡«)</label>
          <input type="url" id="post-link" placeholder="https://example.com">
        </div>

        <div style="margin-top:2rem;">
          <button type="submit" class="btn">å„²å­˜å…¬å‘Š</button>
          <button type="button" onclick="resetForm()" class="btn btn-secondary">æ¸…ç©º / å–æ¶ˆç·¨è¼¯</button>
        </div>
      </form>
    </section>

    <section>
      <h2>å…¬å‘Šåˆ—è¡¨</h2>
      <div class="table-container">
        <table id="admin-table">
          <caption>å·²ç™¼å¸ƒçš„å…¬å‘Šæ¸…å–®</caption>
          <thead>
            <tr>
              <th scope="col" style="width:15%">æ—¥æœŸ</th>
              <th scope="col" style="width:30%">æ¨™é¡Œ</th>
              <th scope="col" style="width:15%">åˆ†é¡</th>
              <th scope="col" style="width:10%">é™„ä»¶</th>
              <th scope="col" style="width:15%">ç‹€æ…‹</th>
              <th scope="col" style="width:15%">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="admin-tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="view-cats" class="view" role="main">
    <header>
      <h1 tabindex="-1">åˆ†é¡ç®¡ç†</h1>
      <button onclick="switchView('view-admin')" class="btn btn-secondary">è¿”å›å…¬å‘Šç®¡ç†</button>
    </header>
    <section style="background:var(--input-bg); padding:1.5rem; border:0.125rem solid var(--border); margin:2rem 0;">
      <h2>æ–°å¢ / ä¿®æ”¹åˆ†é¡</h2>
      <form id="cat-form" onsubmit="handleCatSave(event)">
        <input type="hidden" id="cat-id">
        <div class="form-group" style="display:flex; gap:1rem; align-items:flex-end; flex-wrap:wrap;">
          <div style="flex-grow:1;">
            <label for="cat-name">åˆ†é¡åç¨±</label>
            <input type="text" id="cat-name" required placeholder="ä¾‹å¦‚ï¼šç¸½å‹™è™•ã€æ¦®è­½æ¦œ">
          </div>
          <button type="submit" class="btn">å„²å­˜åˆ†é¡</button>
        </div>
      </form>
    </section>
    <section>
      <h2>ç¾æœ‰åˆ†é¡åˆ—è¡¨</h2>
      <div class="table-container">
        <table id="cat-table">
          <thead><tr><th scope="col">åˆ†é¡åç¨±</th><th scope="col">æ“ä½œ</th></tr></thead>
          <tbody id="cat-tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="view-users" class="view" role="main">
    <header>
      <h1 tabindex="-1">ä½¿ç”¨è€…ç®¡ç†</h1>
      <button onclick="switchView('view-admin')" class="btn btn-secondary">è¿”å›å…¬å‘Šç®¡ç†</button>
    </header>
    <section style="background:var(--input-bg); padding:1.5rem; border:0.125rem solid var(--border); margin:2rem 0;">
      <h2 id="user-form-title">æ–°å¢ä½¿ç”¨è€…</h2>
      <form id="user-form" onsubmit="handleUserSave(event)">
        <input type="hidden" id="user-is-edit" value="false">
        
        <div class="form-group">
          <label for="new-username">å¸³è™Ÿ (å¿…å¡«)</label>
          <input type="text" id="new-username" required autocomplete="off">
          <small id="user-edit-hint" style="display:none; color:#b00; font-weight:bold;">(ç·¨è¼¯æ¨¡å¼ä¸‹ç„¡æ³•ä¿®æ”¹å¸³è™Ÿ)</small>
        </div>
        
        <div class="form-group">
          <label for="new-jobtitle">é¡¯ç¤ºè·ç¨± (å¿…å¡«ï¼Œå¦‚ï¼šæ•™å­¸çµ„é•·)</label>
          <input type="text" id="new-jobtitle" required autocomplete="off" placeholder="å…¬å‘Šæ™‚å°‡é¡¯ç¤ºæ­¤åç¨±">
        </div>

        <div class="form-group">
          <label for="new-password">å¯†ç¢¼</label>
          <input type="password" id="new-password" required autocomplete="new-password">
        </div>
        
        <fieldset style="border: 0.125rem solid var(--border); padding: 1rem; background:var(--bg);">
          <legend style="font-weight:bold; padding: 0 0.5rem;">æ¬Šé™è¨­å®š (å¯å¤šé¸)</legend>
          
          <div class="checkbox-item" style="margin-bottom:1rem; border-color:var(--text);">
            <input type="checkbox" id="role-super" value="ç³»çµ±ç®¡ç†å“¡">
            <label for="role-super" style="margin:0; color:#b00;">ç³»çµ±ç®¡ç†å“¡ (æ“æœ‰æ‰€æœ‰æ¬Šé™)</label>
          </div>
          
          <hr style="border-top:1px solid var(--border); margin:1rem 0;">
          <p style="margin:0 0 0.5rem 0;"><strong>ä¸€èˆ¬åˆ†é¡æ¬Šé™ï¼š</strong></p>
          <div id="permission-checkboxes" class="checkbox-group">
            </div>
        </fieldset>

        <div style="margin-top:2rem;">
          <button type="submit" class="btn" id="btn-save-user">æ–°å¢ä½¿ç”¨è€…</button>
          <button type="button" class="btn btn-secondary" onclick="resetUserForm()">é‡ç½® / å–æ¶ˆç·¨è¼¯</button>
        </div>
      </form>
    </section>
    <section>
      <h2>ç¾æœ‰ä½¿ç”¨è€…åˆ—è¡¨</h2>
      <div class="table-container">
        <table id="user-table">
          <thead>
            <tr>
              <th scope="col">å¸³è™Ÿ</th>
              <th scope="col">è·ç¨±</th>
              <th scope="col">æ¬Šé™çµ„åˆ¥</th>
              <th scope="col">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="user-tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€é‡è¦ã€‘è«‹å°‡é€™è£¡æ›æˆæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (çµå°¾æ˜¯ /exec) ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbznZsbIC1zzOyUSTEAjIzDt0vdp7aYYggvaAYpo0f4r1iGabWJzKvq98PW27cFsOpDI/exec";

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let allPublicData = [];
    let categories = [];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => { 
      loadCategories(); 
      loadPublicData(); 
    });

    // ========== æ ¸å¿ƒï¼šAPI å‘¼å«å‡½å¼ (ä½¿ç”¨ fetch) ==========
    async function callApi(op, data = {}) {
      // è®€å–é¡æ“ä½œç”¨ GET
      if (['getPublicData', 'getCategories'].includes(op)) {
        try {
          const res = await fetch(`${API_URL}?op=${op}`);
          return await res.json();
        } catch (e) {
          throw new Error("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç¶²å€");
        }
      } 
      // å¯«å…¥/æ•æ„Ÿæ“ä½œç”¨ POST
      else {
        try {
          const res = await fetch(API_URL, {
            method: 'POST',
            // GAS çš„ doPost å° text/plain æ”¯æ´åº¦æœ€å¥½ï¼Œé¿å… preflight é¸é …è«‹æ±‚å•é¡Œ
            body: JSON.stringify({ op, ...data }) 
          });
          const json = await res.json();
          if (json.error) throw new Error(json.error);
          return json;
        } catch (e) {
          throw new Error("æ“ä½œå¤±æ•—ï¼š" + e.message);
        }
      }
    }

    // ========== è¼”åŠ©å·¥å…· ==========
    function showMessage(msg) { 
      const el = document.getElementById('global-status'); 
      el.textContent = msg; 
      el.style.display = 'block'; 
      setTimeout(() => el.style.display = 'none', 5000); 
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({ name: file.name, mimeType: file.type, data: reader.result });
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // è¦–åœ–åˆ‡æ›èˆ‡è³‡æ–™æ›´æ–°
    function switchView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
      const view = document.getElementById(id); 
      view.classList.add('active-view');
      
      // å°‡ç„¦é»ç§»è‡³æ¨™é¡Œï¼Œå”åŠ©è®€å±è»Ÿé«”
      const h1 = view.querySelector('h1'); 
      if(h1) h1.focus();
      
      // ç‰¹å®šè¦–åœ–çš„è‡ªå‹•è¼‰å…¥é‚è¼¯
      if(id === 'view-users') loadUsers();
      if(id === 'view-public') {
         document.getElementById('category-filter').value = 'all';
         document.getElementById('public-list').innerHTML = '<p style="padding:1rem;">è³‡æ–™æ›´æ–°ä¸­...</p>';
         loadPublicData(); // åˆ‡æ›å›å‰å°æ™‚è‡ªå‹•é‡æ•´
      }
    }

    // ========== 1. å…¬é–‹è³‡æ–™é‚è¼¯ ==========
    function loadCategories() { 
      callApi('getCategories').then(data => { 
        categories = data; 
        renderCategorySelects(); 
        renderCategoryTable(); 
      }).catch(err => console.error(err));
    }
    
    function loadPublicData() { 
      callApi('getPublicData').then(data => { 
        allPublicData = data; 
        renderPublic(data); 
      }).catch(err => {
        document.getElementById('public-list').innerHTML = `<p style="color:red; padding:1rem;">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼š${err.message}</p>`;
      });
    }

    function renderCategorySelects() {
      const filter = document.getElementById('category-filter');
      const adminSelect = document.getElementById('post-cat');
      let options = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
      filter.innerHTML = `<option value="all">é¡¯ç¤ºæ‰€æœ‰åˆ†é¡</option>` + options; filter.disabled = false;
      adminSelect.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡åˆ†é¡</option>` + options;
    }
    
    function renderPublic(data) {
      const list = document.getElementById('public-list');
      if (data.length === 0) { list.innerHTML = '<p style="padding:1.5rem; border:0.125rem solid #000;">ç›®å‰æ²’æœ‰ä»»ä½•å…¬å‘Šã€‚</p>'; return; }
      list.innerHTML = data.map(item => {
        const pinBadge = item.isPinned ? '<div class="pin-badge">ğŸ“Œ ç½®é ‚å…¬å‘Š</div>' : '';
        const srText = item.isPinned ? '<span class="visually-hidden">æ­¤ç‚ºç½®é ‚æ¶ˆæ¯ï¼š</span>' : '';
        const attachHtml = item.attachment ? `<a href="${item.attachment}" target="_blank" class="attachment-link">ğŸ“ ä¸‹è¼‰é™„ä»¶ / é è¦½</a>` : '';
        
        return `
          <article class="announcement ${item.isPinned ? 'pinned-post' : ''}">
            ${pinBadge}
            <h2>${srText}${item.title}</h2>
            <p><strong>${item.date}</strong> | ${item.category} | ç™¼å¸ƒè€…ï¼š${item.authorTitle}</p>
            <div style="margin-top:1rem;">${item.content.replace(/\n/g, '<br>')}</div>
            ${attachHtml}
            ${item.link ? `<div style="margin-top:1rem;"><a href="${item.link}" target="_blank" class="btn">é–±è®€æ›´å¤š <span class="visually-hidden">é—œæ–¼ ${item.title}</span></a></div>` : ''}
          </article>`;
      }).join('');
    }
    
    function applyFilter() {
      const cat = document.getElementById('category-filter').value;
      const filtered = cat === 'all' ? allPublicData : allPublicData.filter(d => d.category === cat);
      renderPublic(filtered);
      // AAA: ç‹€æ…‹å›å ±
      document.getElementById('filter-status').textContent = `ç¯©é¸å®Œæˆï¼Œé¡¯ç¤º ${filtered.length} ç­†è³‡æ–™`;
    }

    // ========== 2. ç™»å…¥é‚è¼¯ ==========
    function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      
      showMessage("ç™»å…¥ä¸­...");
      callApi('login', { username: u, password: p }).then(res => {
        if(res.error) throw new Error(res.error);
        currentUser = res.username;
        // é¡¯ç¤º è·ç¨± æˆ– å¸³è™Ÿ
        document.getElementById('user-display').textContent = `${res.jobTitle || res.username}`;
        
        // æ¬Šé™åˆ¤æ–·é¡¯ç¤ºæŒ‰éˆ•
        const btnCat = document.getElementById('btn-manage-cats');
        const btnUser = document.getElementById('btn-manage-users');
        if(res.isSuperAdmin) {
          btnCat.style.display = 'inline-block';
          btnUser.style.display = 'inline-block';
        } else {
          btnCat.style.display = 'none';
          btnUser.style.display = 'none';
        }

        loadAdminData(); 
        switchView('view-admin'); 
        document.getElementById('login-form').reset();
      }).catch(err => showMessage(err.message));
    }
    
    function logout() { 
      currentUser = null; 
      switchView('view-public'); 
      showMessage("å·²æˆåŠŸç™»å‡º"); 
    }

    // ========== 3. å¾Œå°å…¬å‘Šç®¡ç† ==========
    function loadAdminData() {
      callApi('getAdminData', { currentUser }).then(data => {
         document.getElementById('admin-tbody').innerHTML = data.map(item => `
          <tr style="${item.author === currentUser ? 'background:rgba(255,215,0,0.1);' : ''}">
            <td>${item.date}</td>
            <td>${item.title}</td>
            <td>
              ${item.category} 
              ${item.isPinned ? '<br><small style="color:#b00; font-weight:bold;">ğŸ“Œç½®é ‚</small>' : ''}
            </td>
            <td>${item.attachment ? 'âœ… æœ‰' : '-'}</td>
            <td>${item.authorTitle}</td>
            <td>
              ${item.isMine ? `
                <button onclick='editPost(${JSON.stringify(item)})' class="btn" style="font-size:0.9rem;">ç·¨è¼¯</button>
                <button onclick='deletePost("${item.id}")' class="btn btn-danger" style="font-size:0.9rem;">åˆªé™¤</button>
              ` : '<span style="color:#666;">ç„¡æ¬Šé™</span>'}
            </td>
          </tr>`).join('');
      }).catch(err => console.error(err));
    }

    async function handleSave(e) {
      e.preventDefault();
      showMessage("æ­£åœ¨å„²å­˜å…¬å‘Šèˆ‡æª”æ¡ˆï¼Œè«‹ç¨å€™...");
      try {
        const fileInput = document.getElementById('post-file');
        let fileData = null;
        // å¦‚æœæœ‰é¸æª”æ¡ˆï¼Œå…ˆè½‰ Base64
        if (fileInput.files.length > 0) fileData = await readFileAsBase64(fileInput.files[0]);

        const formData = {
          id: document.getElementById('post-id').value,
          title: document.getElementById('post-title').value,
          content: document.getElementById('post-content').value,
          category: document.getElementById('post-cat').value,
          link: document.getElementById('post-link').value,
          expiryDate: document.getElementById('post-expiry').value,
          isPinned: document.getElementById('post-pinned').checked.toString(),
          pinExpiry: document.getElementById('post-pin-expiry').value,
          deleteAttachment: document.getElementById('delete-attachment').checked.toString(),
          fileData: fileData
        };

        if (!formData.category) { alert("è«‹é¸æ“‡å…¬å‘Šåˆ†é¡"); return; }
        
        await callApi('saveAnnouncement', { formObj: formData, currentUser });
        showMessage("å…¬å‘Šå„²å­˜æˆåŠŸï¼"); 
        resetForm(); 
        loadAdminData();
        
      } catch (err) { showMessage("å„²å­˜å¤±æ•—ï¼š" + err.message); }
    }
    
    function editPost(item) {
      document.getElementById('post-id').value = item.id;
      document.getElementById('post-title').value = item.title;
      document.getElementById('post-content').value = item.content;
      document.getElementById('post-cat').value = item.category;
      document.getElementById('post-link').value = item.link;
      document.getElementById('post-expiry').value = item.expiryDate;
      document.getElementById('post-pinned').checked = item.isPinned;
      document.getElementById('post-pin-expiry').value = item.pinExpiry;
      
      // é™„ä»¶è™•ç†
      const infoDiv = document.getElementById('current-attachment-info');
      const link = document.getElementById('existing-file-link');
      if (item.attachment) { 
        infoDiv.style.display = 'block'; 
        link.href = item.attachment; 
      } else { 
        infoDiv.style.display = 'none'; 
      }
      // é‡ç½®æª”æ¡ˆæ¬„ä½
      document.getElementById('post-file').value = "";
      document.getElementById('delete-attachment').checked = false;
      
      // ç„¦é»ç§»è‡³æ¨™é¡Œ
      document.getElementById('post-title').focus();
      showMessage(`æ­£åœ¨ç·¨è¼¯ï¼š${item.title}`);
    }

    function deletePost(id) { 
      if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿç„¡æ³•å¾©åŸã€‚")) {
        callApi('deleteAnnouncement', { id, currentUser })
          .then(() => { showMessage("å…¬å‘Šå·²åˆªé™¤"); loadAdminData(); })
          .catch(err => showMessage(err.message)); 
      }
    }

    function resetForm() { 
      document.getElementById('admin-form').reset(); 
      document.getElementById('post-id').value = ""; 
      document.getElementById('current-attachment-info').style.display = 'none'; 
    }

    // ========== 4. åˆ†é¡ç®¡ç† ==========
    function handleCatSave(e) { 
        e.preventDefault(); 
        const id = document.getElementById('cat-id').value;
        const name = document.getElementById('cat-name').value;
        callApi('saveCategory', { id, name, currentUser }).then(res => {
            if(res.error) throw new Error(res.error);
            showMessage("åˆ†é¡å„²å­˜æˆåŠŸ"); 
            document.getElementById('cat-form').reset(); 
            document.getElementById('cat-id').value=""; 
            loadCategories(); // é‡è¼‰åˆ†é¡ä»¥æ›´æ–°ä¸‹æ‹‰é¸å–®
        }).catch(err => showMessage(err.message));
    }
    
    function editCat(id, name) { 
      document.getElementById('cat-id').value = id; 
      document.getElementById('cat-name').value = name; 
      document.getElementById('cat-name').focus(); 
    }
    
    function deleteCat(id) { 
      if(confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ")) {
        callApi('deleteCategory', { id, currentUser }).then(() => { 
          showMessage("åˆ†é¡å·²åˆªé™¤"); loadCategories(); 
        }); 
      }
    }
    
    function renderCategoryTable() { 
      document.getElementById('cat-tbody').innerHTML = categories.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>
            <button onclick="editCat('${c.id}', '${c.name}')" class="btn">ä¿®æ”¹</button>
            <button onclick="deleteCat('${c.id}')" class="btn btn-danger">åˆªé™¤</button>
          </td>
        </tr>`).join(''); 
    }

    // ========== 5. ä½¿ç”¨è€…ç®¡ç† ==========
    function loadUsers() {
      // å‹•æ…‹ç”Ÿæˆ Checkbox é¸å–®
      const container = document.getElementById('permission-checkboxes');
      container.innerHTML = categories.map(c => `
        <div class="checkbox-item">
          <input type="checkbox" id="perm-${c.name}" name="user-permissions" value="${c.name}">
          <label for="perm-${c.name}" style="margin:0;">${c.name}</label>
        </div>`).join('');
      
      callApi('getUsers', { currentUser }).then(users => {
         document.getElementById('user-tbody').innerHTML = users.map(u => `
          <tr>
            <td>${u.username}</td>
            <td>${u.jobTitle}</td>
            <td>${u.group}</td>
            <td>
              ${u.username === currentUser ? '<span style="color:#666;">(ç›®å‰ç™»å…¥)</span>' : `
                <button onclick='editUser(${JSON.stringify(u)})' class="btn">ä¿®æ”¹</button>
                <button onclick="deleteUser('${u.username}')" class="btn btn-danger">åˆªé™¤</button>
              `}
            </td>
          </tr>`).join('');
      });
    }
    
    function handleUserSave(e) {
      e.preventDefault();
      let selectedGroups = [];
      if(document.getElementById('role-super').checked) selectedGroups.push('ç³»çµ±ç®¡ç†å“¡');
      document.querySelectorAll('input[name="user-permissions"]:checked').forEach(cb => selectedGroups.push(cb.value));
      
      if(selectedGroups.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¬Šé™ï¼"); return; }
      
      const formData = {
        isEdit: document.getElementById('user-is-edit').value === 'true',
        username: document.getElementById('new-username').value,
        password: document.getElementById('new-password').value,
        jobTitle: document.getElementById('new-jobtitle').value,
        group: selectedGroups.join(',')
      };
      
      callApi('saveUser', { formObj: formData, currentUser }).then(() => {
          showMessage("ä½¿ç”¨è€…å„²å­˜æˆåŠŸ"); 
          resetUserForm(); 
          loadUsers();
      }).catch(err => showMessage(err.message));
    }
    
    function editUser(user) {
      document.getElementById('user-form-title').textContent = "ä¿®æ”¹ä½¿ç”¨è€…"; 
      document.getElementById('btn-save-user').textContent = "æ›´æ–°è³‡æ–™"; 
      document.getElementById('user-is-edit').value = "true";
      
      const userInput = document.getElementById('new-username'); 
      userInput.value = user.username; 
      userInput.readOnly = true; 
      userInput.style.backgroundColor = "#e0e0e0"; 
      document.getElementById('user-edit-hint').style.display = 'inline';
      
      document.getElementById('new-jobtitle').value = user.jobTitle;
      
      // å¯†ç¢¼è¨­ç‚ºéå¿…å¡«
      const passInput = document.getElementById('new-password'); 
      passInput.value = ""; 
      passInput.placeholder = "ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç¢¼"; 
      passInput.required = false;
      
      // å‹¾é¸æ¬Šé™
      const groups = user.group.split(',');
      document.getElementById('role-super').checked = groups.includes('ç³»çµ±ç®¡ç†å“¡');
      document.querySelectorAll('input[name="user-permissions"]').forEach(cb => cb.checked = groups.includes(cb.value));
      
      document.getElementById('new-jobtitle').focus();
    }
    
    function resetUserForm() {
      document.getElementById('user-form').reset(); 
      document.getElementById('user-form-title').textContent = "æ–°å¢ä½¿ç”¨è€…"; 
      document.getElementById('btn-save-user').textContent = "æ–°å¢ä½¿ç”¨è€…"; 
      document.getElementById('user-is-edit').value = "false";
      
      const userInput = document.getElementById('new-username'); 
      userInput.readOnly = false; 
      userInput.style.backgroundColor = ""; 
      document.getElementById('user-edit-hint').style.display = 'none';
      
      const passInput = document.getElementById('new-password'); 
      passInput.placeholder = ""; 
      passInput.required = true;
    }
    
    function deleteUser(u) { 
      if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä½¿ç”¨è€…ï¼Ÿ")) {
        callApi('deleteUser', { targetUsername: u, currentUser }).then(() => { 
          showMessage("ä½¿ç”¨è€…å·²åˆªé™¤"); loadUsers(); 
        }); 
      }
    }

  </script>
</body>
</html>