<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å…¬å‘Šç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">

  <style>
    /* ========== åŸºç¤è¨­å®š ========== */
    :root { 
      --bg: #ffffff; --text: #000000; --focus: #FFD700; --border: #000000; 
      --input-bg: #f9f9f9; --card-bg: #ffffff; --card-hover: #fcfcfc;
      --gray-border: #ccc;
    }
    
    html, body { 
      font-family: "Iansui", "Helvetica Neue", Arial, sans-serif; 
      background: var(--bg); color: var(--text); 
      font-size: 100%; line-height: 1.6; margin: 0; padding: 0; 
    }
    
    body { padding: 1.5rem; max-width: 64rem; margin: 0 auto; }
    *:focus { outline: 0.25rem solid var(--focus) !important; outline-offset: 0.125rem; }
    
    /* ğŸ‘‡ ä¿®æ­£é‡é»ï¼šæŒ‰éˆ•å¿…é ˆæ˜ç¢ºè¨­å®šç¹¼æ‰¿å­—å‹ ğŸ‘‡ */
    button, input, select, textarea, .btn {
      font-family: inherit; /* å¼·åˆ¶ç¹¼æ‰¿ Iansui å­—é«” */
    }

    .btn { 
      padding: 0.5rem 1rem; 
      background: var(--text); 
      color: var(--bg); 
      border: 2px solid transparent; 
      cursor: pointer; 
      font-weight: bold; 
      border-radius: 4px; 
      display: inline-block; 
      text-decoration: none; 
      font-size: 1rem; 
    }
    .btn:hover { opacity: 0.8; text-decoration: underline; }
    .btn-danger { background: #cc0000; color: #fff; }
    .btn-secondary { background: transparent; color: var(--text); border: 2px solid var(--border); }
    
    input, select, textarea { 
      width: 100%; padding: 10px; margin-bottom: 15px; 
      background: var(--input-bg); color: var(--text); 
      border: 2px solid var(--border); box-sizing: border-box; 
      font-size: 1rem; border-radius: 4px; 
    }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    
    dialog { background: var(--bg); color: var(--text); border: 3px solid var(--border); border-radius: 8px; padding: 20px; max-width: 50rem; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    dialog::backdrop { background: rgba(0, 0, 0, 0.7); }
    
    /* ä¸€èˆ¬å…¬å‘Šåˆ—è¡¨ */
    .post-list-item { padding: 1.5rem; border-bottom: 1px solid var(--gray-border); cursor: pointer; transition: background 0.2s; background: var(--card-bg); }
    .post-list-item:hover { background: var(--card-hover); }
    .post-list-item h2 { margin: 0 0 0.5rem 0; font-size: 1.4rem; color: #000; text-decoration: underline; text-underline-offset: 4px; }
    .badge-pin { background: #b00; color: #fff; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; margin-right: 5px; font-weight: bold; }

    /* ========== æ¦®è­½æ¦œæ¨£å¼ ========== */
    #honor-roll-section { 
      margin-top: 4rem; 
      margin-bottom: 3rem; 
      border: 1px solid var(--gray-border); 
      border-radius: 8px; 
      overflow: hidden; 
      display: none; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    #honor-roll-header { 
      background: #f5f5f5; 
      color: var(--text);          
      padding: 15px 20px; 
      font-size: 1.5rem; 
      font-weight: bold; 
      display: flex; align-items: center; gap: 10px; 
      border-bottom: 1px solid var(--gray-border);
    }

    .honor-card { display: flex; flex-wrap: wrap; background: #fff; border-bottom: 1px solid var(--gray-border); }
    .honor-card:last-child { border-bottom: none; }

    .honor-media { 
      flex: 0 0 400px; max-width: 100%; min-height: 250px; 
      background: #f9f9f9; position: relative; 
      display: flex; align-items: center; justify-content: center; overflow: hidden;
    }
    .honor-media img { width: 100%; height: 250px; object-fit: contain; background: #f0f0f0; display: block; }
    
    .honor-content { flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: center; min-width: 300px; }
    .honor-content h3 { margin: 0 0 10px 0; font-size: 1.6rem; }
    .honor-content p { margin: 0 0 15px 0; color: #555; font-size: 1.1rem; }

    .carousel-controls {
      position: absolute; bottom: 10px; left: 10px; display: flex; gap: 10px;
      background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 20px;
    }
    .carousel-btn {
      background: transparent; color: #fff; border: 1px solid #fff; 
      width: 32px; height: 32px; border-radius: 50%; 
      cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; padding: 0;
    }
    .carousel-btn:hover { background: #fff; color: #000; }
    .carousel-btn:focus { outline: 3px solid var(--focus); }

    /* Flexbox Order Control */
    .ctrl-prev { order: 1; } 
    .ctrl-play { order: 2; }
    .ctrl-next { order: 3; }

    @media (max-width: 768px) {
      .honor-card { flex-direction: column; }
      .honor-media { flex: auto; width: 100%; height: auto; }
      .honor-media img { height: auto; max-height: 300px; }
    }

    /* åˆ†é æŒ‰éˆ• */
    .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; padding-bottom: 20px; }
    .page-btn { padding: 8px 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
    .page-btn.active { background: #000; color: #fff; border-color:#000; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* å…¶ä»– */
    .view { display: none; } .active-view { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .status-msg { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 1rem 2rem; border: 3px solid var(--focus); z-index: 2000; display: none; }
    .cat-disabled { text-decoration: line-through; color: #888; }
    .status-on { background: #d4edda; color: #155724; padding: 2px 5px; border-radius: 3px; }
    .status-off { background: #f8d7da; color: #721c24; padding: 2px 5px; border-radius: 3px; }
  </style>
</head>
<body>

  <div id="global-status" role="alert" class="status-msg"></div>

  <div id="view-public" class="view active-view">
    <header style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--border); padding-bottom:15px; margin-bottom:25px;">
      <h1 style="margin:0; font-size:2rem;">æœ€æ–°å…¬å‘Š</h1>
      <button onclick="switchView('view-login')" class="btn">ç®¡ç†å“¡ç™»å…¥</button>
    </header>

    <div style="margin-bottom:20px;">
      <label for="category-filter">å…¬å‘Šåˆ†é¡ç¯©é¸ï¼š</label>
      <select id="category-filter" onchange="applyFilter()"><option value="all">è¼‰å…¥ä¸­...</option></select>
    </div>

    <div id="public-list" style="border-top: 2px solid var(--border);">
      <p style="padding: 20px;">è³‡æ–™è¼‰å…¥ä¸­...</p>
    </div>

    <div id="pagination-controls" class="pagination"></div>

    <section id="honor-roll-section" aria-label="æ¦®è­½æ¦œå±•ç¤ºå€">
      <div id="honor-roll-header">
        <span role="img" aria-label="çç›ƒ">ğŸ†</span> æ¦®è­½æ¦œ
      </div>
      <div id="honor-list">
        </div>
      <div id="honor-pagination" class="pagination"></div>
    </section>
  </div>

  <dialog id="detail-modal">
    <div style="text-align:right; margin-bottom:10px;">
      <button onclick="closeDetail()" class="btn btn-secondary" aria-label="é—œé–‰è¦–çª—">é—œé–‰ âœ•</button>
    </div>
    <div id="modal-content"></div>
  </dialog>

  <div id="view-login" class="view">
    <h1 style="text-align:center;">ç®¡ç†å“¡ç™»å…¥</h1>
    <form onsubmit="handleLogin(event)" style="max-width:25rem; margin:auto; border:3px solid var(--border); padding:30px; border-radius:8px;">
      <label for="username">å¸³è™Ÿ</label><input type="text" id="username" required>
      <label for="password">å¯†ç¢¼</label><input type="password" id="password" required>
      <div style="margin-top:20px; text-align:center;">
        <button type="submit" class="btn">ç™»å…¥</button>
        <button type="button" class="btn btn-secondary" onclick="switchView('view-public')">å–æ¶ˆ</button>
      </div>
    </form>
  </div>

  <div id="view-admin" class="view">
    <header style="border-bottom:3px solid var(--border); padding-bottom:15px; margin-bottom:25px;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <h1 style="margin:0; font-size:1.5rem;">å¾Œå° - <span id="user-display"></span></h1>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button onclick="switchView('view-public')" class="btn btn-secondary">å‰å°</button>
          <button id="btn-cats" onclick="switchView('view-cats')" class="btn btn-secondary" style="display:none;">åˆ†é¡</button>
          <button id="btn-users" onclick="switchView('view-users')" class="btn btn-secondary" style="display:none;">ä½¿ç”¨è€…</button>
          <button onclick="openChangePasswordModal()" class="btn btn-secondary">æ”¹å¯†ç¢¼</button>
          <button onclick="logout()" class="btn">ç™»å‡º</button>
        </div>
      </div>
    </header>

    <div style="background:var(--input-bg); padding:25px; border:2px solid var(--border); margin-bottom:30px; border-radius:8px;">
      <h2 style="margin-top:0;">ç™¼å¸ƒ/ç·¨è¼¯å…¬å‘Š</h2>
      <form id="admin-form" onsubmit="handleSave(event)">
        <input type="hidden" id="post-id">
        <label for="post-title">æ¨™é¡Œ</label><input type="text" id="post-title" required>
        <label for="post-cat">åˆ†é¡</label><select id="post-cat" required><option>è¼‰å…¥ä¸­...</option></select>
        <label for="post-content">å…§å®¹</label><textarea id="post-content" rows="6" required></textarea>
        
        <div id="author-select-group" style="display:none; margin-bottom:15px;">
          <label for="post-author" style="color:#b00;">æŒ‡å®šç™¼å¸ƒè€… (ç¸½ç®¡)ï¼š</label>
          <select id="post-author"><option value="">(ä¿ç•™åŸç™¼å¸ƒè€…)</option></select>
        </div>

        <div style="border:2px dashed var(--border); padding:15px; margin-bottom:20px; background:#fff;">
          <label for="post-file">é™„ä»¶ (åœ–ç‰‡å°‡ç”¨æ–¼æ¦®è­½æ¦œè¼ªæ’­)</label>
          <input type="file" id="post-file" multiple>
          <div id="current-attachment-info" style="display:none; margin-top:10px;">
            <p><strong>ç›®å‰é™„ä»¶ï¼š</strong></p><ul id="existing-file-list" style="margin-0;padding-left:20px;"></ul>
            <label for="delete-attachment" style="color:#b00; margin-top:10px; display:block;"><input type="checkbox" id="delete-attachment" style="width:auto;"> åˆªé™¤æ‰€æœ‰èˆŠé™„ä»¶</label>
          </div>
        </div>

        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
          <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="post-pinned" style="width:auto; margin:0;"> è¨­ç‚ºç½®é ‚</label>
          <div style="display:flex; align-items:center; gap:5px;"><label for="post-pin-expiry" style="margin:0;">æœŸé™ï¼š</label><input type="date" id="post-pin-expiry" style="width:auto; margin:0;"></div>
        </div>
        
        <div style="display:flex; gap:20px;">
          <div style="flex:1;"><label for="post-expiry">ä¸‹æ¶æ—¥</label><input type="date" id="post-expiry"></div>
          <div style="flex:1;"><label for="post-link">å¤–éƒ¨é€£çµ</label><input type="url" id="post-link"></div>
        </div>
        
        <div style="margin-top:15px;"><button type="submit" class="btn">å„²å­˜</button><button type="button" onclick="resetForm()" class="btn btn-secondary">æ¸…ç©º</button></div>
      </form>
    </div>
    <div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse;"><thead><tr><th style="border:1px solid #000; padding:8px;">æ¨™é¡Œ</th><th style="border:1px solid #000; padding:8px;">åˆ†é¡</th><th style="border:1px solid #000; padding:8px;">æ“ä½œ</th></tr></thead><tbody id="admin-tbody"></tbody></table></div>
  </div>

  <div id="view-cats" class="view">
    <header><h1>åˆ†é¡ç®¡ç†</h1><button onclick="switchView('view-admin')" class="btn btn-secondary">è¿”å›</button></header>
    <div style="background:var(--input-bg); padding:20px; border:2px solid var(--border); margin:20px 0; border-radius:8px;">
      <form id="cat-form" onsubmit="handleCatSave(event)" style="display:flex; gap:10px; align-items:flex-end;">
        <input type="hidden" id="cat-id">
        <div style="flex-grow:1;"><label for="cat-name">åˆ†é¡åç¨±</label><input type="text" id="cat-name" required style="margin:0;"></div>
        <button type="submit" class="btn">å„²å­˜</button>
      </form>
    </div>
    <div class="table-container"><table><thead><tr><th>åç¨±</th><th>æ“ä½œ</th></tr></thead><tbody id="cat-tbody"></tbody></table></div>
  </div>

  <div id="view-users" class="view">
    <header><h1>ä½¿ç”¨è€…ç®¡ç†</h1><button onclick="switchView('view-admin')" class="btn btn-secondary">è¿”å›</button></header>
    <div style="background:var(--input-bg); padding:25px; border:2px solid var(--border); margin:20px 0; border-radius:8px;">
      <h2 style="margin-top:0;" id="user-form-title">æ–°å¢ä½¿ç”¨è€…</h2>
      <form id="user-form" onsubmit="handleUserSave(event)">
        <input type="hidden" id="user-is-edit" value="false">
        <label for="new-username">å¸³è™Ÿ (å¿…å¡«)</label><input type="text" id="new-username" required autocomplete="off">
        <label for="new-jobtitle">è·ç¨± (å¿…å¡«)</label><input type="text" id="new-jobtitle" required autocomplete="off">
        <label for="new-password">å¯†ç¢¼</label><input type="password" id="new-password" autocomplete="new-password">
        <div style="border:2px solid var(--border); padding:15px; background:#fff;">
          <p style="margin:0 0 10px 0; font-weight:bold;">æ¬Šé™è¨­å®šï¼š</p>
          <label for="role-super" style="margin-bottom:10px; color:#b00;"><input type="checkbox" id="role-super" style="width:auto;"> ç³»çµ±ç®¡ç†å“¡ (å…¨æ¬Šé™)</label>
          <hr style="margin:10px 0;">
          <div style="margin-bottom:10px; padding-bottom:5px; border-bottom:1px dashed #ccc;"><label for="perm-select-all" style="cursor:pointer; color:#0056b3;"><input type="checkbox" id="perm-select-all" onchange="toggleAllPerms(this)" style="width:auto;"> å…¨é¸ / å–æ¶ˆå…¨é¸</label></div>
          <div id="permission-checkboxes" style="display:flex; flex-wrap:wrap; gap:15px;"></div>
        </div>
        <div style="margin-top:20px;"><button type="submit" class="btn" id="btn-save-user">æ–°å¢ä½¿ç”¨è€…</button><button type="button" class="btn btn-secondary" onclick="resetUserForm()">é‡ç½®</button></div>
      </form>
    </div>
    <div class="table-container"><table><thead><tr><th>å¸³è™Ÿ</th><th>è·ç¨±</th><th>æ¬Šé™</th><th>æ“ä½œ</th></tr></thead><tbody id="user-tbody"></tbody></table></div>
  </div>

  <dialog id="password-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">
      <h2 style="margin:0;">ä¿®æ”¹å€‹äººå¯†ç¢¼</h2><button onclick="document.getElementById('password-modal').close()" class="btn btn-secondary">é—œé–‰</button>
    </div>
    <form onsubmit="handleChangePassword(event)">
      <label for="cp-old">èˆŠå¯†ç¢¼</label><input type="password" id="cp-old" required>
      <label for="cp-new">æ–°å¯†ç¢¼</label><input type="password" id="cp-new" required>
      <label for="cp-confirm">ç¢ºèªæ–°å¯†ç¢¼</label><input type="password" id="cp-confirm" required>
      <div style="text-align:right; margin-top:15px;"><button type="submit" class="btn">ç¢ºèªä¿®æ”¹</button></div>
    </form>
  </dialog>

  <script>
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹å‹™å¿…æ›¿æ›æˆæ‚¨çš„ GAS ç¶²å€ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbwoAtocGgeoAPjKDgI3by1xOPMTsb68BL4ihhNDMxZTjVOZnv2NiQZUFrgEoqNBXFqu/exec";

    let currentUser = null, allPublicData = [], currentFilteredData = [], categories = [];
    const ITEMS_PER_PAGE = 5; let currentPage = 1;
    let honorData = []; const HONOR_PER_PAGE = 3; let currentHonorPage = 1;
    const carouselTimers = {}; 

    document.addEventListener('DOMContentLoaded', () => { loadCategories(); loadPublicData(); });

    // å·¥å…·: ä¿®å¾© Drive é€£çµ
    function getDriveImgUrl(url) {
      if (!url) return "";
      let id = "";
      if (url.includes("id=")) id = url.split("id=")[1].split("&")[0];
      else if (url.includes("/d/")) id = url.split("/d/")[1].split("/")[0];
      return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w2000` : url;
    }

    async function callApi(op, data = {}) {
      try {
        const url = ['getPublicData', 'getCategories'].includes(op) ? `${API_URL}?op=${op}` : API_URL;
        const opts = ['getPublicData', 'getCategories'].includes(op) ? {} : { method: 'POST', body: JSON.stringify({ op, ...data }) };
        const res = await fetch(url, opts);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        return json;
      } catch (e) { throw new Error("é€£ç·šéŒ¯èª¤ï¼š" + e.message); }
    }

    function showMessage(msg) { const el = document.getElementById('global-status'); el.textContent = msg; el.style.display='block'; setTimeout(()=>el.style.display='none',3000); }
    function readFileAsBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res({ name: file.name, mimeType: file.type, data: r.result }); r.onerror = rej; r.readAsDataURL(file); }); }

    function switchView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
      document.getElementById(id).classList.add('active-view');
      window.scrollTo(0,0);
      if (id === 'view-public') { document.getElementById('category-filter').value = 'all'; loadPublicData(); }
      if (id === 'view-users') loadUsers();
    }

    // ========== å…¬é–‹è³‡æ–™ & æ¦®è­½æ¦œ ==========
    function loadCategories() { callApi('getCategories').then(d => { categories = d; renderCategorySelects(); renderCategoryTable(); }); }
    
    function loadPublicData() { 
      callApi('getPublicData').then(d => { 
        allPublicData = d; 
        initHonorRoll(); 
        applyFilter(); 
      }).catch(e => document.getElementById('public-list').innerHTML='<p style="padding:20px;color:red;">è³‡æ–™è¼‰å…¥å¤±æ•—</p>'); 
    }

    function initHonorRoll() {
      honorData = allPublicData.filter(d => d.category && d.category.indexOf("æ¦®è­½æ¦œ") !== -1);
      const section = document.getElementById('honor-roll-section');
      if (honorData.length === 0) {
        section.style.display = 'none';
      } else {
        section.style.display = 'block';
        currentHonorPage = 1;
        renderHonorRollPage();
      }
    }

    // ğŸ† æ¸²æŸ“æ¦®è­½æ¦œ
    function renderHonorRollPage() {
      Object.keys(carouselTimers).forEach(key => stopAutoPlay(key));
      const container = document.getElementById('honor-list');
      const pagination = document.getElementById('honor-pagination');
      const start = (currentHonorPage - 1) * HONOR_PER_PAGE;
      const displayData = honorData.slice(start, start + HONOR_PER_PAGE);

      container.innerHTML = displayData.map((item, localIdx) => {
        const carouselKey = item.id;
        const attachs = item.attachments || [];
        const images = attachs.filter(f => f.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));
        
        let mediaContent = '';
        if (images.length === 0) {
          mediaContent = `<div style="color:#aaa; font-size:2rem;">ğŸ†</div>`;
        } else if (images.length === 1) {
          mediaContent = `<img src="${getDriveImgUrl(images[0].url)}" alt="${images[0].name}">`;
        } else {
          const processedImages = images.map(img => ({ name: img.name, url: getDriveImgUrl(img.url) }));
          const imgJson = JSON.stringify(processedImages).replace(/"/g, '&quot;'); 
          
          mediaContent = `
            <img src="${processedImages[0].url}" id="honor-img-${carouselKey}" data-idx="0" data-imgs="${imgJson}" alt="è¼ªæ’­åœ–ç‰‡">
            <div class="carousel-controls">
              <button class="carousel-btn ctrl-play" onclick="togglePlay('${carouselKey}')" id="play-btn-${carouselKey}" aria-label="æš«åœ/æ’­æ”¾">âšâš</button>
              <button class="carousel-btn ctrl-prev" onclick="moveSlide('${carouselKey}', -1)" aria-label="ä¸Šä¸€å¼µ">â®</button>
              <button class="carousel-btn ctrl-next" onclick="moveSlide('${carouselKey}', 1)" aria-label="ä¸‹ä¸€å¼µ">â¯</button>
            </div>`;
          startAutoPlay(carouselKey, processedImages.length);
        }

        const globalIndex = allPublicData.indexOf(item);

        return `
          <div class="honor-card">
            <div class="honor-media">${mediaContent}</div>
            <div class="honor-content">
              <h3>${item.title}</h3>
              <p>${item.date} | ${item.authorTitle}</p>
              <div style="max-height:100px; overflow:hidden; text-overflow:ellipsis;">${item.content.substring(0, 100)}...</div>
              <div style="margin-top:10px;">
                <button onclick="openDetail(${globalIndex})" class="btn">æŸ¥çœ‹è©³æƒ…</button>
              </div>
            </div>
          </div>`;
      }).join('');

      const totalPages = Math.ceil(honorData.length / HONOR_PER_PAGE);
      if (totalPages > 1) {
        let html = `<button class="page-btn" onclick="changeHonorPage(${currentHonorPage-1})" ${currentHonorPage===1?'disabled':''}>&laquo;</button>`;
        for(let i=1; i<=totalPages; i++) html += `<button class="page-btn ${i===currentHonorPage?'active':''}" onclick="changeHonorPage(${i})">${i}</button>`;
        html += `<button class="page-btn" onclick="changeHonorPage(${currentHonorPage+1})" ${currentHonorPage===totalPages?'disabled':''}>&raquo;</button>`;
        pagination.innerHTML = html;
      } else {
        pagination.innerHTML = '';
      }
    }

    function changeHonorPage(p) {
      const total = Math.ceil(honorData.length / HONOR_PER_PAGE);
      if (p < 1 || p > total) return;
      currentHonorPage = p;
      renderHonorRollPage();
    }

    function startAutoPlay(key, count) {
      if (carouselTimers[key]) clearInterval(carouselTimers[key]);
      carouselTimers[key] = setInterval(() => moveSlide(key, 1, true), 3000);
    }

    function moveSlide(key, dir, isAuto = false) {
      const img = document.getElementById(`honor-img-${key}`);
      if (!img) return;
      const images = JSON.parse(img.dataset.imgs);
      let current = parseInt(img.dataset.idx);
      current = (current + dir + images.length) % images.length;
      img.src = images[current].url;
      img.dataset.idx = current;
      if (!isAuto) stopAutoPlay(key);
    }

    function togglePlay(key) {
      const btn = document.getElementById(`play-btn-${key}`);
      if (carouselTimers[key]) {
        stopAutoPlay(key);
        btn.textContent = "â–¶"; 
      } else {
        const img = document.getElementById(`honor-img-${key}`);
        const images = JSON.parse(img.dataset.imgs);
        startAutoPlay(key, images.length);
        btn.textContent = "âšâš"; 
      }
    }

    function stopAutoPlay(key) {
      if (carouselTimers[key]) {
        clearInterval(carouselTimers[key]);
        delete carouselTimers[key];
        const btn = document.getElementById(`play-btn-${key}`);
        if(btn) btn.textContent = "â–¶";
      }
    }

    // ========== ä¸€èˆ¬åˆ—è¡¨ ==========
    function renderCategorySelects() {
      const html = categories.filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
      document.getElementById('category-filter').innerHTML = `<option value="all">æ‰€æœ‰åˆ†é¡</option>` + html;
      document.getElementById('post-cat').innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡...</option>` + html;
    }

    function applyFilter() {
      const cat = document.getElementById('category-filter').value;
      currentFilteredData = (cat === 'all') ? allPublicData : allPublicData.filter(d => d.category === cat);
      currentPage = 1;
      renderCurrentPage();
    }

    function renderCurrentPage() {
      const list = document.getElementById('public-list');
      const controls = document.getElementById('pagination-controls');
      if (currentFilteredData.length === 0) { list.innerHTML = '<p style="padding:20px;">ç„¡å…¬å‘Š</p>'; controls.innerHTML=''; return; }

      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const displayData = currentFilteredData.slice(start, start + ITEMS_PER_PAGE);

      list.innerHTML = displayData.map((item, index) => {
        const pinHtml = item.isPinned ? `<span class="badge-pin">ğŸ“Œ ç½®é ‚</span>` : '';
        const attachBadge = (item.attachments && item.attachments.length > 0) ? ' | ğŸ“ å«é™„ä»¶' : '';
        // ä¿®æ­£ï¼šä½¿ç”¨ globalIndex
        const globalIndex = allPublicData.indexOf(item);
        
        return `
          <div class="post-list-item" onclick="openDetail(${globalIndex})" tabindex="0">
            ${pinHtml} <h2>${item.title}</h2>
            <div class="post-meta"><strong>${item.date}</strong> | ${item.category} | ${item.authorTitle} ${attachBadge}</div>
          </div>`;
      }).join('');
      
      renderPaginationControls();
    }

    function renderPaginationControls() {
      const total = Math.ceil(currentFilteredData.length / ITEMS_PER_PAGE);
      const div = document.getElementById('pagination-controls');
      if(total<=1){ div.innerHTML=''; return; }
      
      let html = `<button class="page-btn" onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>&laquo;</button>`;
      for(let i=1; i<=total; i++) html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;
      html += `<button class="page-btn" onclick="changePage(${currentPage+1})" ${currentPage===total?'disabled':''}>&raquo;</button>`;
      div.innerHTML = html;
    }
    function changePage(p) { 
      const total = Math.ceil(currentFilteredData.length / ITEMS_PER_PAGE);
      if(p<1 || p>total) return; 
      currentPage = p; renderCurrentPage(); window.scrollTo(0,0); 
    }

    function openDetail(index) {
      const item = allPublicData[index];
      if (!item) return;
      const modal = document.getElementById('detail-modal');
      const content = document.getElementById('modal-content');
      
      let attachHtml = '';
      if (item.attachments && item.attachments.length > 0) {
        attachHtml = `<div style="margin-top:20px; padding:10px; border:1px dashed #000; background:#f9f9f9;"><strong>é™„ä»¶ï¼š</strong><br>`;
        if (typeof item.attachments === 'string') attachHtml += `<a href="${item.attachments}" target="_blank">ä¸‹è¼‰</a>`;
        else attachHtml += item.attachments.map(f => `<a href="${f.url}" target="_blank" style="margin-right:10px;">ğŸ“ ${f.name}</a>`).join('');
        attachHtml += `</div>`;
      }
      
      content.innerHTML = `
        <h2 style="border-bottom:2px solid #000; padding-bottom:10px;">${item.title}</h2>
        <p style="color:#555;">${item.date} | ${item.category} | ${item.authorTitle}</p>
        <div style="font-size:1.2rem; line-height:1.8; margin-top:20px;">${item.content.replace(/\n/g, '<br>')}</div>
        ${attachHtml}
        ${item.link ? `<div style="margin-top:10px;"><a href="${item.link}" target="_blank" class="btn">ğŸ”— å¤–éƒ¨é€£çµ</a></div>` : ''}
      `;
      modal.showModal();
    }
    function closeDetail() { document.getElementById('detail-modal').close(); }

    // ========== ç™»å…¥/å¾Œå° ==========
    function handleLogin(e) {
      e.preventDefault(); showMessage("ç™»å…¥ä¸­...");
      callApi('login', { username: document.getElementById('username').value, password: document.getElementById('password').value }).then(res => {
        currentUser = res.username;
        document.getElementById('user-display').textContent = res.jobTitle || res.username;
        const isSuper = res.isSuperAdmin;
        document.getElementById('btn-cats').style.display = isSuper ? 'inline-block' : 'none';
        document.getElementById('btn-users').style.display = isSuper ? 'inline-block' : 'none';
        const authorDiv = document.getElementById('author-select-group');
        if (isSuper) { authorDiv.style.display = 'block'; loadAuthorSelect(); } else { authorDiv.style.display = 'none'; }
        loadAdminData(); switchView('view-admin');
      }).catch(e => showMessage(e.message));
    }
    function logout() { currentUser = null; switchView('view-public'); showMessage("å·²ç™»å‡º"); }
    
    function loadAuthorSelect() {
      callApi('getUsers', { currentUser }).then(users => {
        const sel = document.getElementById('post-author');
        sel.innerHTML = '<option value="">(ä¿ç•™åŸç™¼å¸ƒè€…)</option>' + users.map(u => `<option value="${u.username}">${u.username} (${u.jobTitle})</option>`).join('');
      });
    }

    function loadAdminData() {
      callApi('getAdminData', { currentUser }).then(d => {
        document.getElementById('admin-tbody').innerHTML = d.map(i => `
          <tr style="${i.author === currentUser ? 'background:#eef;' : ''}">
            <td style="border:1px solid #000; padding:8px;">${i.title}</td>
            <td style="border:1px solid #000; padding:8px;">${i.category}</td>
            <td style="border:1px solid #000; padding:8px;">
              ${i.isMine ? `<button onclick='editPost(${JSON.stringify(i)})' class="btn" style="padding:2px 5px;">ä¿®</button> <button onclick='deletePost("${i.id}")' class="btn btn-danger" style="padding:2px 5px;">åˆª</button>` : '-'}
            </td>
          </tr>`).join('');
      });
    }

    async function handleSave(e) {
      e.preventDefault(); showMessage("å„²å­˜ä¸­...");
      try {
        const fileInput = document.getElementById('post-file');
        let filesData = [];
        if (fileInput.files.length > 0) filesData = await Promise.all(Array.from(fileInput.files).map(readFileAsBase64));
        const formData = {
          id: document.getElementById('post-id').value,
          title: document.getElementById('post-title').value,
          content: document.getElementById('post-content').value,
          category: document.getElementById('post-cat').value,
          link: document.getElementById('post-link').value,
          expiryDate: document.getElementById('post-expiry').value,
          isPinned: document.getElementById('post-pinned').checked.toString(),
          pinExpiry: document.getElementById('post-pin-expiry').value,
          deleteAttachment: document.getElementById('delete-attachment').checked.toString(),
          newAuthor: document.getElementById('post-author').value,
          filesData: filesData
        };
        await callApi('saveAnnouncement', { formObj: formData, currentUser });
        showMessage("æˆåŠŸ"); resetForm(); loadAdminData();
      } catch (e) { showMessage("å¤±æ•—: " + e.message); }
    }

    function editPost(item) {
      document.getElementById('post-id').value = item.id;
      document.getElementById('post-title').value = item.title;
      document.getElementById('post-content').value = item.content;
      document.getElementById('post-cat').value = item.category;
      document.getElementById('post-link').value = item.link;
      document.getElementById('post-expiry').value = item.expiryDate;
      document.getElementById('post-pinned').checked = item.isPinned;
      document.getElementById('post-pin-expiry').value = item.pinExpiry;
      const list = document.getElementById('existing-file-list');
      list.innerHTML = "";
      if (item.attachments && item.attachments.length > 0) {
        document.getElementById('current-attachment-info').style.display = 'block';
        item.attachments.forEach(f => { list.innerHTML += `<li><a href="${f.url}" target="_blank">${f.name}</a></li>`; });
      } else {
        document.getElementById('current-attachment-info').style.display = 'none';
      }
      document.getElementById('post-files').value = "";
      document.getElementById('post-title').focus();
    }
    
    function deletePost(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) callApi('deleteAnnouncement', {id, currentUser}).then(()=>{ showMessage("å·²åˆªé™¤"); loadAdminData(); }); }
    function resetForm() { document.getElementById('admin-form').reset(); document.getElementById('post-id').value=""; document.getElementById('current-attachment-info').style.display='none'; }

    // åˆ†é¡ & ä½¿ç”¨è€…ç®¡ç†
    function handleCatSave(e) { e.preventDefault(); callApi('saveCategory', { id: document.getElementById('cat-id').value, name: document.getElementById('cat-name').value, currentUser }).then(()=>{ showMessage("æˆåŠŸ"); document.getElementById('cat-form').reset(); document.getElementById('cat-id').value=""; loadCategories(); }); }
    function editCat(id, name) { document.getElementById('cat-id').value = id; document.getElementById('cat-name').value = name; }
    function toggleCat(id, isActive) { if(confirm("ç¢ºå®šåˆ‡æ›ï¼Ÿ")) callApi('toggleCategoryStatus', {id, isActive, currentUser}).then(()=>{ showMessage("æˆåŠŸ"); loadCategories(); }); }
    function deleteCat(id) { if(confirm("åˆªé™¤ï¼Ÿ")) callApi('deleteCategory', {id, currentUser}).then(()=>{ showMessage("å·²åˆªé™¤"); loadCategories(); }); }
    function renderCategoryTable() { document.getElementById('cat-tbody').innerHTML = categories.map(c => `<tr><td style="border:1px solid #000;padding:8px;"><span class="${c.isActive?'':'cat-disabled'}">${c.name}</span></td><td style="border:1px solid #000;padding:8px;"><button onclick="editCat('${c.id}','${c.name}')" class="btn">ä¿®</button> <button onclick="toggleCat('${c.id}',${!c.isActive})" class="btn ${c.isActive?'btn-danger':'btn'}">${c.isActive?'åœ':'å•Ÿ'}</button> <button onclick="deleteCat('${c.id}')" class="btn btn-secondary">åˆª</button></td></tr>`).join(''); }

    function loadUsers() {
      const container = document.getElementById('permission-checkboxes');
      container.innerHTML = categories.map(c => `<label style="margin-right:10px;"><input type="checkbox" name="user-permissions" value="${c.name}"> ${c.name}</label>`).join('');
      callApi('getUsers', { currentUser }).then(users => { document.getElementById('user-tbody').innerHTML = users.map(u => `<tr><td style="border:1px solid #000;padding:8px;">${u.username}</td><td style="border:1px solid #000;padding:8px;">${u.jobTitle}</td><td style="border:1px solid #000;padding:8px;"><button onclick='editUser(${JSON.stringify(u)})' class="btn">ä¿®</button> <button onclick="deleteUser('${u.username}')" class="btn btn-danger">åˆª</button></td></tr>`).join(''); });
    }
    function toggleAllPerms(src) { document.querySelectorAll('input[name="user-permissions"]').forEach(cb => cb.checked = src.checked); }
    function handleUserSave(e) {
      e.preventDefault();
      let selected = []; if(document.getElementById('role-super').checked) selected.push('ç³»çµ±ç®¡ç†å“¡');
      document.querySelectorAll('input[name="user-permissions"]:checked').forEach(cb => selected.push(cb.value));
      const data = { isEdit: document.getElementById('user-is-edit').value==='true', username: document.getElementById('new-username').value, password: document.getElementById('new-password').value, jobTitle: document.getElementById('new-jobtitle').value, group: selected.join(',') };
      callApi('saveUser', { formObj: data, currentUser }).then(()=>{ showMessage("æˆåŠŸ"); resetUserForm(); loadUsers(); });
    }
    function editUser(u) {
      document.getElementById('user-form-title').textContent = "ä¿®æ”¹"; document.getElementById('user-is-edit').value = "true";
      document.getElementById('new-username').value = u.username; document.getElementById('new-username').readOnly = true;
      document.getElementById('new-jobtitle').value = u.jobTitle;
      const grps = u.group.split(','); document.getElementById('role-super').checked = grps.includes('ç³»çµ±ç®¡ç†å“¡');
      document.querySelectorAll('input[name="user-permissions"]').forEach(cb => cb.checked = grps.includes(cb.value));
    }
    function resetUserForm() { document.getElementById('user-form').reset(); document.getElementById('user-form-title').textContent="æ–°å¢"; document.getElementById('user-is-edit').value="false"; document.getElementById('new-username').readOnly=false; }
    function deleteUser(u) { if(confirm("åˆªé™¤ï¼Ÿ")) callApi('deleteUser', {targetUsername:u, currentUser}).then(()=>{ showMessage("å·²åˆªé™¤"); loadUsers(); }); }
    
    function openChangePasswordModal() { document.getElementById('password-modal').showModal(); }
    function handleChangePassword(e) {
      e.preventDefault();
      const o=document.getElementById('cp-old').value, n=document.getElementById('cp-new').value, c=document.getElementById('cp-confirm').value;
      if(n!==c){alert("å¯†ç¢¼ä¸ç¬¦");return;}
      callApi('changePassword', {username:currentUser, oldPassword:o, newPassword:n}).then(msg=>{alert(msg);document.getElementById('password-modal').close();});
    }
  </script>
</body>
</html>